<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Terapeuta PRO - E2EE JSON</title>
    <style>
        /* Zmienne CSS dla trybu Jasnego (Domy≈õlnego) */
        :root { 
            --p: #059669; 
            --p-hover: #047857;
            --p-light: rgba(5, 150, 105, 0.1);
            --bg: #f8fafc; 
            --card: #ffffff; 
            --txt: #1e293b; 
            --border: #e2e8f0; 
            --danger: #ef4444;
            --input-bg: #ffffff;
            --muted: #64748b;
        }

        /* Zmienne CSS dla trybu Ciemnego */
        [data-theme="dark"] {
            --p: #10b981;
            --p-hover: #059669;
            --p-light: rgba(16, 185, 129, 0.15);
            --bg: #0f172a; 
            --card: #1e293b; 
            --txt: #f8fafc; 
            --border: #334155; 
            --input-bg: #0f172a;
            --muted: #94a3b8;
        }

        body { 
            font-family: system-ui, -apple-system, sans-serif; 
            background: var(--bg); 
            color: var(--txt); 
            margin: 0; 
            padding: 20px; 
            display: flex; 
            justify-content: center; 
            transition: background-color 0.3s, color 0.3s;
            box-sizing: border-box;
            min-height: 100vh;
        }

        .container { 
            display: flex; 
            gap: 20px; 
            width: 100%; 
            max-width: 1400px; 
            height: calc(100vh - 40px); 
        }
        
        /* Pasek boczny */
        .sidebar { 
            width: 320px; 
            display: flex; 
            flex-direction: column; 
            gap: 15px; 
            flex-shrink: 0;
        }

        .card { 
            background: var(--card); 
            padding: 15px; 
            border-radius: 12px; 
            border: 1px solid var(--border); 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); 
            transition: background-color 0.3s, border-color 0.3s;
        }
        
        /* Widok g≈Ç√≥wny */
        .main { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            background: var(--card); 
            border-radius: 12px; 
            border: 1px solid var(--border); 
            overflow: hidden; 
            transition: background-color 0.3s, border-color 0.3s;
        }
        
        .nav { display: flex; border-bottom: 1px solid var(--border); background: var(--card); }
        .nav-btn { 
            flex: 1; 
            padding: 15px; 
            border: none; 
            background: none; 
            cursor: pointer; 
            color: var(--muted); 
            font-weight: 600; 
            border-bottom: 3px solid transparent;
            border-radius: 0;
            margin-bottom: 0;
            transition: color 0.2s, border-color 0.2s;
        }
        .nav-btn.active { color: var(--p); border-bottom-color: var(--p); }

        /* Elementy formularza */
        input, textarea, select, button { 
            width: 100%; 
            padding: 12px; 
            margin-bottom: 10px; 
            border-radius: 8px; 
            border: 1px solid var(--border); 
            background: var(--input-bg); 
            color: var(--txt); 
            box-sizing: border-box; 
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s, background-color 0.3s, color 0.3s;
        }
        input:focus, textarea:focus, select:focus { border-color: var(--p); }
        
        button { 
            background: var(--p); 
            color: white; 
            border: none; 
            font-weight: bold; 
            cursor: pointer; 
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        button:hover { background: var(--p-hover); }
        button.sec { background: transparent; color: var(--txt); border: 1px solid var(--border); }
        button.sec:hover { background: var(--bg); }
        
        /* Lista pacjent√≥w */
        .patient-list { overflow-y: auto; flex: 1; margin-top: 10px; }
        .patient-item { 
            padding: 12px; 
            border-radius: 8px; 
            cursor: pointer; 
            margin-bottom: 5px; 
            border-left: 4px solid transparent; 
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .patient-item:hover { background: var(--bg); }
        .patient-item.active { background: var(--p-light); border-left-color: var(--p); color: var(--p); }

        /* Panele edytora i kalendarza */
        #editor, #calendar { display: none; flex-direction: column; flex: 1; padding: 20px; overflow-y: auto; }
        #editor.active, #calendar.active { display: flex; }
        
        .editor-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .editor-header h2 { margin: 0; font-size: 20px; }

        textarea { 
            flex: 1; 
            min-height: 300px; 
            font-family: monospace; 
            font-size: 15px; 
            resize: none; 
            line-height: 1.6;
        }
        
        /* Zdjƒôcia */
        .gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; margin-top: 10px; }
        .gallery img { width: 100%; height: 100px; object-fit: cover; border-radius: 8px; cursor: pointer; border: 1px solid var(--border); transition: opacity 0.2s; }
        .gallery img:hover { opacity: 0.8; }

        /* Kalendarz */
        .time-row { display: flex; align-items: center; gap: 15px; margin-bottom: 10px; background: var(--bg); padding: 10px; border-radius: 8px; border: 1px solid var(--border); }
        .time-row span { width: 50px; font-weight: bold; font-size: 14px; text-align: right; color: var(--muted); }
        .time-row select { margin-bottom: 0; flex: 1; }

        /* --- TRYB SKUPIENIA (ZEN MODE) --- */
        .zen-close-btn { display: none; position: fixed; top: 15px; right: 20px; z-index: 10001; width: auto; background: var(--danger); padding: 10px 20px; }
        
        body.zen-mode { padding: 0; }
        body.zen-mode .sidebar { display: none !important; }
        body.zen-mode .nav { display: none !important; }
        body.zen-mode .editor-header { display: none !important; }
        body.zen-mode #photoSection { display: none !important; }
        body.zen-mode .main { border: none; border-radius: 0; height: 100vh; }
        body.zen-mode #editor { padding: 0; }
        body.zen-mode textarea { 
            height: 100vh; 
            border-radius: 0; 
            border: none; 
            padding: 40px 15%; 
            font-size: 18px; 
            margin: 0;
        }
        body.zen-mode .zen-close-btn { display: block; }

        /* --- WSPARCIE MOBILNE (RWD) --- */
        @media (max-width: 900px) {
            body { padding: 10px; }
            .container { flex-direction: column; height: auto; display: block; }
            .sidebar { width: 100%; margin-bottom: 20px; }
            .main { min-height: 70vh; }
            .patient-list { max-height: 250px; border: 1px solid var(--border); border-radius: 8px; }
            body.zen-mode textarea { padding: 20px; }
        }
    </style>
</head>
<body>

<button class="zen-close-btn" onclick="toggleZenMode()">‚úñ Wyjd≈∫ z trybu pisania</button>

<div class="container">
    <div class="sidebar">
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <label style="font-size: 12px; font-weight: bold; color: var(--muted); margin: 0;">HAS≈ÅO (AES-256)</label>
                <button onclick="toggleTheme()" class="sec" style="width: auto; padding: 5px 10px; margin: 0; font-size: 12px;">Dzie≈Ñ / Noc</button>
            </div>
            
            <input type="password" id="pass" placeholder="Wprowad≈∫ klucz...">
            
            <button onclick="openFile()">üìÇ Otw√≥rz Bazƒô</button>
            <button class="sec" onclick="saveFile()" id="btnSave" style="display:none">üíæ Zapisz Zmiany</button>
            <button class="sec" onclick="createEmptyDb()" style="margin-top: 15px; font-size: 12px;">üì• Utw√≥rz nowƒÖ (pustƒÖ) bazƒô</button>
            
            <input type="file" id="mobileFileInput" accept=".enc" style="display: none;" onchange="handleMobileFile(event)">
        </div>
        
        <div class="card" style="flex: 1; display: flex; flex-direction: column;">
            <button onclick="addPatient()">‚ûï Nowy Pacjent</button>
            <div class="patient-list" id="pList">
                <div style="text-align: center; color: var(--muted); font-size: 13px; padding: 20px;">Otw√≥rz bazƒô, aby zobaczyƒá listƒô.</div>
            </div>
        </div>
        <div id="status" style="font-size: 12px; text-align: center; color: var(--p); font-weight: bold; min-height: 15px;"></div>
    </div>

    <div class="main">
        <div class="nav">
            <button class="nav-btn active" id="btnViewEditor" onclick="setView('editor')">üìù Karta Pacjenta</button>
            <button class="nav-btn" id="btnViewCalendar" onclick="setView('calendar')">üìÖ Kalendarz</button>
        </div>

        <div id="editor" class="active">
            <div class="editor-header">
                <h2 id="pTitle">Brak wybranego pacjenta</h2>
                <button class="sec" id="btnZen" style="width: auto; margin: 0; display: none;" onclick="toggleZenMode()">‚õ∂ Pe≈Çny ekran</button>
            </div>
            
            <textarea id="notes" oninput="updateNotes()" placeholder="Wybierz pacjenta z listy po lewej stronie, aby rozpoczƒÖƒá edycjƒô..." disabled></textarea>
            
            <div id="photoSection" style="display:none; margin-top: 20px; border-top: 1px solid var(--border); padding-top: 15px;">
                <label style="font-size: 12px; font-weight: bold; color: var(--muted);">ZA≈ÅƒÑCZNIKI (JPG/PNG - automatyczna kompresja)</label>
                <input type="file" id="imgInp" accept="image/*" onchange="uploadImg(this)" style="margin-top:10px">
                <div class="gallery" id="pGallery"></div>
            </div>
        </div>

        <div id="calendar">
            <label style="font-size: 12px; font-weight: bold; color: var(--muted);">WYBIERZ DZIE≈É</label>
            <input type="date" id="calDate" onchange="renderCal()" style="max-width: 250px;">
            <div id="calSlots" style="margin-top: 15px;"></div>
        </div>
    </div>
</div>

<script>
    // --- STRUKTURA BAZY I ZMIENNE GLOBALNE ---
    let db = { patients: {}, calendar: {} };
    let activePid = null;
    let fileHandle = null; // Uchwyt pliku dla PC (File System Access API)
    const ITER = 100000;   // Ilo≈õƒá iteracji dla PBKDF2

    // --- INICJALIZACJA MOTYWU ---
    function initTheme() {
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
    }
    initTheme();

    function toggleTheme() {
        const current = document.documentElement.getAttribute('data-theme');
        const next = current === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', next);
        localStorage.setItem('theme', next);
    }

    // --- TRYB SKUPIENIA (ZEN MODE) ---
    function toggleZenMode() {
        document.body.classList.toggle('zen-mode');
        if(document.body.classList.contains('zen-mode')) {
            document.getElementById('notes').focus();
        }
    }

    // --- NAWIGACJA ZAK≈ÅADEK ---
    function setView(v) {
        document.getElementById('editor').classList.toggle('active', v === 'editor');
        document.getElementById('calendar').classList.toggle('active', v === 'calendar');
        document.getElementById('btnViewEditor').classList.toggle('active', v === 'editor');
        document.getElementById('btnViewCalendar').classList.toggle('active', v === 'calendar');
        if(v === 'calendar') {
            if(!document.getElementById('calDate').value) {
                document.getElementById('calDate').value = new Date().toISOString().split('T')[0];
            }
            renderCal();
        }
    }

    function msg(text, isError = false) {
        const s = document.getElementById('status');
        s.innerText = text;
        s.style.color = isError ? "var(--danger)" : "var(--p)";
        setTimeout(() => s.innerText = '', 4000);
    }

    // --- ZARZƒÑDZANIE PACJENTAMI ---
    function addPatient() {
        const name = prompt("Podaj inicja≈Çy, kod lub nazwisko pacjenta:");
        if(!name || !name.trim()) return;
        const id = 'p_' + Date.now();
        db.patients[id] = { name: name.trim(), notes: "", imgs: [] };
        
        document.getElementById('btnSave').style.display = 'flex'; // Poka≈º przycisk zapisu je≈õli by≈Ç ukryty
        renderPList();
        selectPatient(id);
    }

    function renderPList() {
        const c = document.getElementById('pList');
        c.innerHTML = '';
        const keys = Object.keys(db.patients);
        
        if(keys.length === 0) {
            c.innerHTML = '<div style="text-align: center; color: var(--muted); font-size: 13px; padding: 20px;">Brak pacjent√≥w w bazie.</div>';
            return;
        }

        keys.forEach(id => {
            const div = document.createElement('div');
            div.className = `patient-item ${id === activePid ? 'active' : ''}`;
            div.innerText = db.patients[id].name;
            div.onclick = () => selectPatient(id);
            c.appendChild(div);
        });
    }

    function selectPatient(id) {
        activePid = id;
        const p = db.patients[id];
        document.getElementById('pTitle').innerText = p.name;
        
        const notesArea = document.getElementById('notes');
        notesArea.value = p.notes;
        notesArea.disabled = false;
        notesArea.placeholder = "Wpisuj notatki pacjenta tutaj...";
        
        document.getElementById('photoSection').style.display = 'block';
        document.getElementById('btnZen').style.display = 'flex';
        
        renderPList();
        renderGallery();
        setView('editor');
    }

    function updateNotes() {
        if(activePid) db.patients[activePid].notes = document.getElementById('notes').value;
    }

    // --- ZDJƒòCIA (Base64) ---
    function uploadImg(input) {
        if(!activePid || !input.files[0]) return;
        const reader = new FileReader();
        reader.onload = e => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const max = 1000;
                let w = img.width, h = img.height;
                if(w > max) { h *= max/w; w = max; }
                canvas.width = w; canvas.height = h;
                ctx.drawImage(img, 0, 0, w, h);
                db.patients[activePid].imgs.push(canvas.toDataURL('image/jpeg', 0.6));
                renderGallery();
                input.value = ''; // Reset
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(input.files[0]);
    }

    function renderGallery() {
        if(!activePid) return;
        const g = document.getElementById('pGallery');
        g.innerHTML = '';
        db.patients[activePid].imgs.forEach(src => {
            const img = document.createElement('img');
            img.src = src;
            img.onclick = () => {
                const w = window.open();
                w.document.write(`<body style="margin:0; background:#000; display:flex; justify-content:center; align-items:center; height:100vh;"><img src="${src}" style="max-width:100%; max-height:100%;"></body>`);
            };
            g.appendChild(img);
        });
    }

    // --- KALENDARZ ---
    function renderCal() {
        const date = document.getElementById('calDate').value;
        if(!date) return;
        
        const container = document.getElementById('calSlots');
        container.innerHTML = '';
        if(!db.calendar[date]) db.calendar[date] = {};

        for(let h=8; h<=20; h++) {
            const time = `${h < 10 ? '0'+h : h}:00`;
            const row = document.createElement('div');
            row.className = 'time-row';
            row.innerHTML = `<span>${time}</span>`;
            
            const sel = document.createElement('select');
            sel.innerHTML = '<option value="">-- Wolny termin --</option>';
            
            Object.keys(db.patients).forEach(pid => {
                sel.innerHTML += `<option value="${pid}" ${db.calendar[date][time] === pid ? 'selected' : ''}>${db.patients[pid].name}</option>`;
            });
            
            sel.onchange = (e) => db.calendar[date][time] = e.target.value;
            row.appendChild(sel);
            container.appendChild(row);
        }
    }

    // --- KRYPTOGRAFIA (AES-GCM JSON) ---
    async function getKey(pw, salt) {
        const b = await crypto.subtle.importKey('raw', new TextEncoder().encode(pw), 'PBKDF2', false, ['deriveKey']);
        return crypto.subtle.deriveKey({name:'PBKDF2', salt, iterations:ITER, hash:'SHA-256'}, b, {name:'AES-GCM', length:256}, false, ['encrypt','decrypt']);
    }

    async function processEncryption(pw) {
        const dataStr = JSON.stringify(db);
        const salt = crypto.getRandomValues(new Uint8Array(16));
        const iv = crypto.getRandomValues(new Uint8Array(12));
        const key = await getKey(pw, salt);
        const cipher = await crypto.subtle.encrypt({name:'AES-GCM', iv}, key, new TextEncoder().encode(dataStr));
        const combined = new Uint8Array(16 + 12 + cipher.byteLength);
        combined.set(salt, 0); 
        combined.set(iv, 16); 
        combined.set(new Uint8Array(cipher), 28);
        return combined;
    }

    async function processDecryption(buffer, pw) {
        const data = new Uint8Array(buffer);
        const key = await getKey(pw, data.slice(0, 16));
        const dec = await crypto.subtle.decrypt({name:'AES-GCM', iv: data.slice(16,28)}, key, data.slice(28));
        const jsonStr = new TextDecoder().decode(dec);
        db = JSON.parse(jsonStr);
        
        // Zabezpieczenie na wypadek brakujƒÖcych obiekt√≥w
        if(!db.patients) db.patients = {};
        if(!db.calendar) db.calendar = {};
        
        activePid = null;
        document.getElementById('notes').value = "";
        document.getElementById('notes').disabled = true;
        document.getElementById('pTitle').innerText = "Wybierz pacjenta";
        document.getElementById('photoSection').style.display = 'none';
        document.getElementById('btnZen').style.display = 'none';
        
        renderPList();
        if(document.getElementById('calendar').classList.contains('active')) renderCal();
        document.getElementById('btnSave').style.display = 'flex';
        msg("Baza poprawnie odszyfrowana!");
    }

    // --- OBS≈ÅUGA PLIK√ìW (PC ORAZ MOBILE) ---
    function createEmptyDb() {
        const pw = document.getElementById('pass').value;
        if(!pw) return alert("Musisz podaƒá has≈Ço w lewym g√≥rnym rogu, aby utworzyƒá nowƒÖ bazƒô!");
        db = { patients: {}, calendar: {} };
        activePid = null;
        fileHandle = null; // Resetujemy uchwyt, zmuszajƒÖc do pobrania przy zapisie
        renderPList();
        document.getElementById('btnSave').style.display = 'flex';
        msg("Nowa pusta baza utworzona w pamiƒôci.");
    }

    async function openFile() {
        const pw = document.getElementById('pass').value;
        if(!pw) return alert("Podaj has≈Ço przed wczytaniem pliku!");

        // Sprawdzamy czy przeglƒÖdarka wspiera bezpo≈õrednie nadpisywanie plik√≥w (PC Chrome/Edge/Opera)
        if (window.showOpenFilePicker) {
            try {
                [fileHandle] = await window.showOpenFilePicker({
                    types: [{ description: 'Zaszyfrowana Baza', accept: {'application/octet-stream': ['.enc']} }]
                });
                const file = await fileHandle.getFile();
                const buffer = await file.arrayBuffer();
                await processDecryption(buffer, pw);
            } catch(e) {
                if(e.name !== 'AbortError') msg("B≈ÇƒÖd odszyfrowania pliku!", true);
            }
        } else {
            // UrzƒÖdzenia mobilne (lub Firefox/Safari)
            document.getElementById('mobileFileInput').click();
        }
    }

    async function handleMobileFile(event) {
        const file = event.target.files[0];
        if(!file) return;
        const pw = document.getElementById('pass').value;
        
        try {
            const buffer = await file.arrayBuffer();
            await processDecryption(buffer, pw);
            event.target.value = ''; // Reset
        } catch(e) {
            msg("B≈Çƒôdne has≈Ço lub plik!", true);
            event.target.value = '';
        }
    }

    async function saveFile() {
        const pw = document.getElementById('pass').value;
        if(!pw) return alert("Nie mo≈ºna zapisaƒá bez has≈Ça!");

        try {
            const encryptedData = await processEncryption(pw);

            // Zapis bezpo≈õrednio do pliku (Tylko PC z obs≈ÇugƒÖ API)
            if (window.showSaveFilePicker && fileHandle) {
                const writable = await fileHandle.createWritable();
                await writable.write(encryptedData);
                await writable.close();
                msg("Zmiany bezpiecznie zapisane na dysku!");
            } 
            // Pobranie zaktualizowanego pliku (Telefony, Firefox, lub nowa baza)
            else {
                const blob = new Blob([encryptedData], {type: 'application/octet-stream'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                
                const d = new Date();
                const dateStr = `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}-${d.getDate().toString().padStart(2,'0')}`;
                a.download = `klinika_baza_${dateStr}.enc`;
                
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                msg("Pobrano zaktualizowanƒÖ bazƒô do folderu 'Pobrane'");
            }
        } catch(e) {
            msg("WystƒÖpi≈Ç b≈ÇƒÖd podczas zapisu!", true);
            console.error(e);
        }
    }
</script>

</body>
</html>
