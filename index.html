<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Terapeutnik 3.0</title>
    
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23059669'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z'/%3E%3C/svg%3E" type="image/svg+xml">

    <style>
        /* --- MOTYWY --- */
        [data-theme="light"] {
            --bg: #f1f5f9;
            --sidebar-bg: #ffffff;
            --card-bg: #ffffff;
            --txt: #334155;
            --txt-head: #0f172a;
            --txt-muted: #64748b;
            --border: #e2e8f0;
            --input-bg: #f8fafc;
            --p: #059669;
            --p-hover: #047857;
            --p-light: #d1fae5;
            --booked: #dcfce7; /* Pastelowa zieleÅ„ dla kalendarza */
            --danger: #ef4444;
            --link: #2563eb;
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
        }

        [data-theme="dark"] {
            --bg: #020617;
            --sidebar-bg: #0f172a;
            --card-bg: #1e293b;
            --txt: #cbd5e1;
            --txt-head: #f8fafc;
            --txt-muted: #94a3b8;
            --border: #334155;
            --input-bg: #020617;
            --p: #10b981;
            --p-hover: #059669;
            --p-light: rgba(16, 185, 129, 0.15);
            --booked: rgba(16, 185, 129, 0.2); /* Ciemniejsza zieleÅ„ dla trybu nocnego */
            --danger: #f87171;
            --link: #60a5fa;
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.3);
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg); color: var(--txt); 
            margin: 0; padding: 0; height: 100vh; overflow: hidden;
            transition: background 0.3s, color 0.3s;
            overscroll-behavior-y: none; /* Zapobiega odÅ›wieÅ¼aniu przy pociÄ…gniÄ™ciu w dÃ³Å‚ */
        }

        /* --- LAYOUT --- */
        #appLayout { display: none; height: 100vh; width: 100vw; display: flex; }
        .sidebar { width: 320px; background: var(--sidebar-bg); border-right: 1px solid var(--border); display: flex; flex-direction: column; flex-shrink: 0; z-index: 10; }
        .main-area { flex-grow: 1; display: flex; flex-direction: column; background: var(--bg); position: relative; overflow: hidden; }

        /* --- UI ELEMENTS --- */
        .btn-icon { background: transparent; border: none; color: var(--txt-muted); padding: 8px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .btn-icon:hover { background: var(--input-bg); color: var(--p); }
        .btn-icon svg { width: 20px; height: 20px; fill: currentColor; }
        
        .btn-primary { background: var(--p); color: white; border: none; padding: 10px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px; }
        .btn-primary:hover { background: var(--p-hover); }

        input, select, textarea { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border); background: var(--input-bg); color: var(--txt); box-sizing: border-box; font-size: 14px; outline: none; transition: border 0.2s; }
        input:focus, select:focus, textarea:focus { border-color: var(--p); }

        /* --- LOGIN --- */
        #loginScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 5000; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .login-card { background: var(--card-bg); width: 100%; max-width: 380px; padding: 40px; border-radius: 20px; box-shadow: var(--shadow); border: 1px solid var(--border); text-align: center; }

        /* --- PACJENCI --- */
        .patient-item { padding: 12px 15px; border-radius: 8px; margin-bottom: 4px; cursor: pointer; font-size: 14px; display: flex; flex-direction: column; gap: 4px; color: var(--txt); border: 1px solid transparent; }
        .patient-item:hover { background: var(--input-bg); border-color: var(--border); }
        .patient-item.active { background: var(--p); color: white; }
        .patient-item.active .sub-info { color: rgba(255,255,255,0.8); }
        .sub-info { font-size: 11px; color: var(--txt-muted); display: flex; justify-content: space-between; }
        
        /* --- EDYTOR & TOOLBAR --- */
        .editor-header { background: var(--sidebar-bg); border-bottom: 1px solid var(--border); padding: 10px 20px; }
        .patient-meta-bar { display: flex; flex-wrap: wrap; gap: 15px; font-size: 12px; color: var(--txt-muted); margin-top: 5px; align-items: center; }
        .meta-tag { background: var(--input-bg); padding: 2px 8px; border-radius: 4px; border: 1px solid var(--border); }
        
        .rich-toolbar { padding: 8px 20px; background: var(--sidebar-bg); border-bottom: 1px solid var(--border); display: flex; gap: 8px; align-items: center; }
        .toolbar-btn { width: 30px; height: 30px; border-radius: 4px; border: 1px solid var(--border); background: var(--card-bg); cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold; font-family: serif; font-size: 16px; color: var(--txt); }
        .toolbar-btn:hover { background: var(--input-bg); }
        
        #content { flex-grow: 1; border: none; padding: 30px; font-size: 16px; line-height: 1.6; color: var(--txt); background: var(--bg); outline: none; overflow-y: auto; white-space: pre-wrap; font-family: inherit; }
        #content a { color: var(--link); text-decoration: underline; cursor: pointer; }
        
        /* --- MODAL EDYCJI --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-card { background: var(--card-bg); width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; border-radius: 12px; padding: 25px; box-shadow: var(--shadow); border: 1px solid var(--border); }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0; }
        .form-full { grid-column: span 2; }
        .form-label { display: block; font-size: 11px; font-weight: bold; color: var(--txt-muted); margin-bottom: 5px; text-transform: uppercase; }

        /* --- GALERIA & KALENDARZ --- */
        .gallery-bar { padding: 15px 20px; background: var(--sidebar-bg); border-top: 1px solid var(--border); display: flex; gap: 12px; overflow-x: auto; }
        .thumb-wrap { position: relative; width: 60px; height: 60px; flex-shrink: 0; }
        .thumb { width: 100%; height: 100%; object-fit: cover; border-radius: 6px; border: 1px solid var(--border); cursor: pointer; }
        .thumb-del { position: absolute; top: -5px; right: -5px; width: 18px; height: 18px; background: var(--danger); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; cursor: pointer; }

        .calendar-view { padding: 30px; overflow-y: auto; height: 100%; display: none; background: var(--bg); }
        .calendar-view.active { display: block; }
        .time-slot { display: flex; margin-bottom: 10px; align-items: center; gap: 15px; max-width: 600px; padding: 5px 10px; border-radius: 8px; transition: background 0.2s; }
        
        /* Styl dla zajÄ™tego terminu (pastelowy zielony) */
        .time-slot.booked { background: var(--booked); border: 1px solid var(--p); }

        /* --- RESPONSIVE & MOBILE GESTURES --- */
        @media (max-width: 768px) {
            .sidebar { position: absolute; width: 100%; height: 100%; transform: translateX(0); transition: 0.3s; }
            .main-area { position: absolute; width: 100%; height: 100%; transform: translateX(100%); transition: 0.3s; z-index: 20; }
            body.view-active .sidebar { transform: translateX(-20%); }
            body.view-active .main-area { transform: translateX(0); }
            .form-grid { grid-template-columns: 1fr; }
            .form-full { grid-column: span 1; }
        }

        #imgModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 6000; display: none; align-items: center; justify-content: center; }
        #imgModal img { max-width: 90%; max-height: 90%; }
        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #1e293b; color: #fff; padding: 12px 24px; border-radius: 50px; font-size: 14px; z-index: 9999; display: none; box-shadow: 0 10px 15px rgba(0,0,0,0.2); }
    </style>
</head>
<body data-theme="light">

<div id="loginScreen">
    <div class="login-card">
        <h2 style="margin: 0 0 5px 0; color: var(--txt-head);">Terapeutnik 3.0</h2>
        <p style="color: var(--txt-muted); font-size: 14px; margin-bottom: 30px;">Mobilne Gesty & BezpieczeÅ„stwo</p>
        <div style="text-align: left;">
            <label class="form-label">UÅ¼ytkownik</label>
            <input type="text" id="loginUser" placeholder="Wpisz nazwÄ™..." style="margin-bottom:15px;">
            <label class="form-label">HasÅ‚o / Klucz</label>
            <input type="password" id="loginPass" placeholder="Wpisz hasÅ‚o...">
        </div>
        <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 25px;">
            <button class="btn-primary" style="justify-content: center;" onclick="handleLogin('open')">OtwÃ³rz bazÄ™</button>
            <button class="btn-icon" style="border: 1px solid var(--border); color: var(--txt); width: 100%;" onclick="handleLogin('create')">UtwÃ³rz nowÄ… bazÄ™</button>
        </div>
        <div id="loginError" style="color:var(--danger); font-size:12px; margin-top:15px;"></div>
    </div>
</div>

<div id="appLayout">
    <div class="sidebar">
        <div class="header-bar" style="padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
            <div style="font-weight: 800; color: var(--p); display: flex; align-items: center; gap: 8px;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 14h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
                Pacjenci
            </div>
            <button class="btn-icon" onclick="toggleTheme()" title="ZmieÅ„ motyw">
                <svg viewBox="0 0 24 24"><path d="M20 15.31L23.31 12 20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69zM12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6 6 2.69 6 6-2.69 6-6 6z"/></svg>
            </button>
        </div>
        
        <div style="padding: 15px;">
            <button class="btn-primary" style="width:100%; justify-content:center;" onclick="addPatient()">+ Dodaj Pacjenta</button>
        </div>
        <div style="padding: 0 15px 10px 15px;">
             <input type="text" id="patientSearch" placeholder="ðŸ” Szukaj (Nazwa, Miasto, Status)..." oninput="renderList()" style="margin-bottom: 0;">
        </div>
        <div class="scroll-area" id="patientList" style="overflow-y: auto; flex-grow: 1; padding: 10px;"></div>

        <div style="padding: 15px; border-top: 1px solid var(--border); background: var(--input-bg);">
            <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <span style="font-size: 12px; font-weight: bold;" id="userDisplay">...</span>
                <button class="btn-icon" style="padding:5px; font-size:11px;" onclick="location.reload()">Wyloguj</button>
            </div>
            <div style="display:flex; gap:8px;">
                <button class="btn-icon" style="flex:1; border:1px solid var(--border); font-size:12px;" onclick="saveToDisk()">ðŸ’¾ ZAPISZ</button>
                <button class="btn-icon" style="flex:1; border:1px solid var(--border); font-size:12px;" onclick="switchTab('calendar')">ðŸ“… KALENDARZ</button>
            </div>
        </div>
    </div>

    <div class="main-area" id="mainArea">
        
        <div id="viewEditor" style="display:flex; flex-direction:column; height:100%;">
            <div class="editor-header">
                <div style="display:flex; justify-content:space-between; align-items: flex-start;">
                    <div style="display:flex; align-items:center;">
                        <button class="btn-icon back-btn" onclick="history.back()" title="WrÃ³Ä‡" style="margin-right:10px; display:none;">
                            <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
                        </button>
                        <div>
                            <div style="font-weight:800; font-size:20px; color:var(--txt-head);" id="activePatientName">Wybierz pacjenta</div>
                            <div class="patient-meta-bar" id="patientMetaDisplay">
                                </div>
                        </div>
                    </div>
                    
                    <div style="display:flex; gap: 8px;">
                        <button class="btn-icon" onclick="openEditModal()" title="Edytuj dane pacjenta">
                            <svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
                        </button>
                        <button class="btn-icon" onclick="addVisitTemplate()" title="Dodaj notatkÄ™ wizyty">
                            <svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>
                        </button>
                        <button class="btn-icon" style="color:var(--danger);" onclick="deletePatient()" title="UsuÅ„ pacjenta">
                            <svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                        </button>
                    </div>
                </div>
            </div>

            <div class="rich-toolbar" id="richToolbar" style="display:none;">
                <button class="toolbar-btn" onclick="fmt('bold')" title="Pogrubienie">B</button>
                <div style="width:1px; height:20px; background:var(--border); margin:0 5px;"></div>
                <button class="toolbar-btn" onclick="fmt('foreColor', 'var(--txt)')" style="color:var(--txt)">A</button>
                <button class="toolbar-btn" onclick="fmt('foreColor', '#ef4444')" style="color:#ef4444">A</button>
                <button class="toolbar-btn" onclick="fmt('foreColor', '#10b981')" style="color:#10b981">A</button>
                <button class="toolbar-btn" onclick="fmt('foreColor', '#3b82f6')" style="color:#3b82f6">A</button>
                <div style="width:1px; height:20px; background:var(--border); margin:0 5px;"></div>
                <button class="toolbar-btn" onclick="addLink()">ðŸ”—</button>
            </div>

            <div id="content" contenteditable="false" placeholder="Wybierz pacjenta..." oninput="updateNotes()"></div>

            <div class="gallery-bar" id="galleryContainer" style="display:none;">
                <div class="thumb-wrap" style="display:flex; align-items:center; justify-content:center; background:var(--input-bg); border:2px dashed var(--border); border-radius:8px; cursor:pointer;" onclick="document.getElementById('imgInp').click()">
                    <span style="font-size:24px; color:var(--txt-muted);">+</span>
                </div>
                <input type="file" id="imgInp" accept="image/*" style="display:none;" onchange="uploadImg(event)">
                <div id="galleryList" style="display:contents;"></div>
            </div>
        </div>

        <div id="viewCalendar" class="calendar-view">
            <div style="display:flex; align-items:center; gap:15px; margin-bottom:25px;">
                <button class="btn-icon" onclick="switchTab('editor')">
                    <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
                </button>
                <h2 style="margin:0;">Terminarz wizyt</h2>
            </div>
            <div style="max-width:300px; margin-bottom:30px;">
                <label style="font-size:12px; font-weight:bold; display:block; margin-bottom:8px;">WYBIERZ DATÄ˜:</label>
                <input type="date" id="calDate" onchange="renderCalendar()">
            </div>
            <div id="timeSlots"></div>
        </div>
    </div>
</div>

<div id="editModal" class="modal-overlay">
    <div class="modal-card">
        <h3 style="margin-top:0;">Dane Pacjenta</h3>
        <label class="form-label">ImiÄ™ i Nazwisko</label>
        <input type="text" id="editName">
        <div class="form-grid">
            <div>
                <label class="form-label">Data Urodzenia</label>
                <input type="date" id="editDob">
            </div>
            <div>
                <label class="form-label">Status</label>
                <select id="editStatus">
                    <option value="Aktywny">Aktywny</option>
                    <option value="ZakoÅ„czony">ZakoÅ„czony</option>
                    <option value="Wstrzymany">Wstrzymany</option>
                    <option value="Konsultacja">Konsultacja</option>
                </select>
            </div>
            <div class="form-full">
                <label class="form-label">Miejsce Zamieszkania (Adres)</label>
                <input type="text" id="editAddress">
            </div>
            <div>
                <label class="form-label">Telefon</label>
                <input type="text" id="editPhone">
            </div>
            <div>
                <label class="form-label">Email</label>
                <input type="email" id="editEmail">
            </div>
            <div>
                <label class="form-label">Miejsce Wizyt</label>
                <input type="text" id="editLocation">
            </div>
            <div style="display:flex; align-items:center; height:100%;">
                <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                    <input type="checkbox" id="editOnline" style="width:auto;">
                    <span style="font-size:14px;">Wizyta Online</span>
                </label>
            </div>
        </div>
        <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
            <button class="btn-icon" style="border:1px solid var(--border);" onclick="closeEditModal()">Anuluj</button>
            <button class="btn-primary" onclick="savePatientDetails()">Zapisz zmiany</button>
        </div>
    </div>
</div>

<div id="imgModal" onclick="this.style.display='none'"><img id="imgFull" src=""></div>
<div id="toast" class="toast"></div>

<script>
    // --- KONFIGURACJA ---
    const PBKDF2_ITER = 100000;
    let db = { patients: {}, calendar: {} };
    let activeId = null;
    let fileHandle = null;
    let authUser = "";
    let authPass = "";
    
    // Zmienne do obsÅ‚ugi gestÃ³w
    let touchStartX = 0;
    let touchStartY = 0;

    window.onload = () => {
        const theme = localStorage.getItem('theme') || 'light';
        document.body.setAttribute('data-theme', theme);
        document.getElementById('calDate').valueAsDate = new Date();
        setupGestures();
    };
    
    // --- OBSÅUGA GESTÃ“W I PRZYCISKU WSTECZ (ANDROID) ---
    
    // NasÅ‚uchiwanie systemowego przycisku wstecz
    window.onpopstate = function(event) {
        if (activeId) {
            // JeÅ¼eli jesteÅ›my w pacjencie, wywoÅ‚ujemy funkcjÄ™ wyjÅ›cia
            // Przekazujemy 'false' aby nie modyfikowaÄ‡ juÅ¼ historii (bo wÅ‚aÅ›nie z niej wrÃ³ciliÅ›my)
            exitView(false);
        }
    };

    function setupGestures() {
        const mainArea = document.getElementById('mainArea');
        
        mainArea.addEventListener('touchstart', (e) => {
            touchStartX = e.changedTouches[0].screenX;
            touchStartY = e.changedTouches[0].screenY;
        }, {passive: true});

        mainArea.addEventListener('touchend', (e) => {
            const touchEndX = e.changedTouches[0].screenX;
            const touchEndY = e.changedTouches[0].screenY;
            handleSwipeGesture(touchEndX, touchEndY);
        }, {passive: true});
    }

    function handleSwipeGesture(endX, endY) {
        // SprawdÅº czy jesteÅ›my w trybie pacjenta
        if (!activeId) return;

        // Warunki gestu "Wstecz" (Swipe w prawo):
        // 1. Ruch w poziomie min. 60px
        // 2. Ruch w pionie max. 50px (Å¼eby nie myliÄ‡ ze scrollowaniem)
        if (endX - touchStartX > 60 && Math.abs(endY - touchStartY) < 50) {
            // WywoÅ‚aj history.back() - to samo co przycisk trÃ³jkÄ…ta
            history.back();
        }
    }

    function toggleTheme() {
        const current = document.body.getAttribute('data-theme');
        const next = current === 'light' ? 'dark' : 'light';
        document.body.setAttribute('data-theme', next);
        localStorage.setItem('theme', next);
    }

    function showToast(m) {
        const t = document.getElementById('toast');
        t.innerText = m;
        t.style.display = 'block'; setTimeout(() => t.style.display = 'none', 3000);
    }

    // --- LOGOWANIE I PLIKI ---
    async function handleLogin(mode) {
        const u = document.getElementById('loginUser').value.trim();
        const p = document.getElementById('loginPass').value;
        if(!u || !p) return document.getElementById('loginError').innerText = "WypeÅ‚nij oba pola.";
        
        authUser = u; authPass = p;
        try {
            if(mode === 'create') {
                db = { patients: {}, calendar: {} };
                if(window.showSaveFilePicker) {
                    fileHandle = await window.showSaveFilePicker({
                        suggestedName: `${u}.json`,
                        types: [{ description: 'Baza JSON', accept: {'application/json': ['.json']} }]
                    });
                }
                await saveToDisk();
                enterApp();
            } else {
                let text;
                if(window.showOpenFilePicker) {
                    [fileHandle] = await window.showOpenFilePicker({
                        types: [{ description: 'Baza JSON', accept: {'application/json': ['.json']} }]
                    });
                    const file = await fileHandle.getFile();
                    text = await file.text();
                } else {
                    const input = document.createElement('input');
                    input.type = 'file'; input.accept = '.json';
                    input.onchange = async e => {
                        const f = e.target.files[0];
                        if(f) {
                            const raw = await f.text();
                            await decryptAndLoad(raw);
                        }
                    };
                    input.click(); return;
                }
                if(text) await decryptAndLoad(text);
            }
        } catch(e) { if(e.name !== 'AbortError') alert(e.message); }
    }

    async function decryptAndLoad(raw) {
        try {
            const wrapper = JSON.parse(raw);
            const decrypted = await decryptData(wrapper, authPass);
            db = JSON.parse(decrypted);
            enterApp();
        } catch(e) { document.getElementById('loginError').innerText = "BÅ‚Ä™dne hasÅ‚o lub plik."; }
    }

    function enterApp() {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('appLayout').style.display = 'flex';
        document.getElementById('userDisplay').innerText = "UÅ¼ytkownik: " + authUser;
        renderList();
    }

    // --- KRYPTOGRAFIA ---
    function b64ToBuf(b) { return Uint8Array.from(atob(b), c => c.charCodeAt(0)); }
    function bufToB64(b) { return btoa(String.fromCharCode.apply(null, new Uint8Array(b))); }

    async function deriveKey(pw, salt) {
        const enc = new TextEncoder();
        const keyMat = await crypto.subtle.importKey('raw', enc.encode(pw), 'PBKDF2', false, ['deriveKey']);
        return crypto.subtle.deriveKey(
            { name: 'PBKDF2', salt: salt, iterations: PBKDF2_ITER, hash: 'SHA-256' },
            keyMat, { name: 'AES-GCM', length: 256 }, false, ['encrypt', 'decrypt']
        );
    }

    async function encryptData(str, pw) {
        const salt = crypto.getRandomValues(new Uint8Array(16));
        const iv = crypto.getRandomValues(new Uint8Array(12));
        const key = await deriveKey(pw, salt);
        const encoded = new TextEncoder().encode(str);
        const encrypted = await crypto.subtle.encrypt({name:'AES-GCM', iv: iv}, key, encoded);
        return { salt: bufToB64(salt), iv: bufToB64(iv), data: bufToB64(encrypted), user: authUser };
    }

    async function decryptData(w, pw) {
        const salt = b64ToBuf(w.salt);
        const iv = b64ToBuf(w.iv);
        const data = b64ToBuf(w.data);
        const key = await deriveKey(pw, salt);
        const dec = await crypto.subtle.decrypt({name:'AES-GCM', iv: iv}, key, data);
        return new TextDecoder().decode(dec);
    }

    async function saveToDisk() {
        try {
            const encrypted = await encryptData(JSON.stringify(db), authPass);
            const blob = new Blob([JSON.stringify(encrypted, null, 2)], {type:'application/json'});
            if(fileHandle) {
                const w = await fileHandle.createWritable();
                await w.write(blob); await w.close();
                showToast("Zapisano zmiany.");
            } else {
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `${authUser}_baza.json`; a.click();
                showToast("Pobrano plik bazy.");
            }
        } catch(e) { alert("BÅ‚Ä…d zapisu: " + e.message); }
    }

    // --- PACJENCI ---
    function addPatient() {
        const n = prompt("Nazwisko i ImiÄ™ (lub InicjaÅ‚y):");
        if(n) {
            const id = 'p' + Date.now();
            db.patients[id] = { 
                name: n, notes: "", images: [],
                dob: "", email: "", phone: "", address: "", location: "", isOnline: false, status: "Aktywny"
            };
            renderList();
            selectPatient(id);
            openEditModal();
        }
    }

    function deletePatient() {
        if(!activeId) return;
        if(confirm(`UsunÄ…Ä‡ trwale pacjenta: ${db.patients[activeId].name}?`)) {
            delete db.patients[activeId];
            for(let d in db.calendar) { for(let h in db.calendar[d]) if(db.calendar[d][h] === activeId) delete db.calendar[d][h]; }
            activeId = null;
            exitView(true); // UÅ¼yj true aby wymusiÄ‡ powrÃ³t w historii
            renderList();
            saveToDisk();
        }
    }

    function renderList() {
        const container = document.getElementById('patientList');
        const query = document.getElementById('patientSearch').value.toLowerCase();
        container.innerHTML = "";
        
        Object.keys(db.patients)
        .filter(id => {
            const p = db.patients[id];
            const text = `${p.name} ${p.location||''} ${p.status||''}`.toLowerCase();
            return text.includes(query);
        })
        .sort((a,b) => db.patients[a].name.localeCompare(db.patients[b].name))
        .forEach(id => {
            const p = db.patients[id];
            const div = document.createElement('div');
            div.className = `patient-item ${id === activeId ? 'active' : ''}`;
            let sub = [];
            if(p.status) sub.push(p.status);
            if(p.location) sub.push(p.location);
            if(p.isOnline) sub.push("Online");
            
            div.innerHTML = `<div style="font-weight:600;">${p.name}</div>
                <div class="sub-info"><span>${sub.join(' â€¢ ')}</span></div>`;
            div.onclick = () => selectPatient(id);
            container.appendChild(div);
        });
    }

    function selectPatient(id) {
        activeId = id;
        const p = db.patients[id];
        
        // --- DODAJEMY STAN DO HISTORII ---
        // DziÄ™ki temu przycisk "Wstecz" zadziaÅ‚a
        history.pushState({view: 'patient', id: id}, "", "#patient");

        document.getElementById('activePatientName').innerText = p.name;
        
        // Oblicz wiek
        let ageInfo = "";
        if(p.dob) {
            const birth = new Date(p.dob);
            const today = new Date();
            let age = today.getFullYear() - birth.getFullYear();
            const m = today.getMonth() - birth.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) age--;
            ageInfo = `${age} lat`;
        }

        const metaContainer = document.getElementById('patientMetaDisplay');
        metaContainer.innerHTML = "";
        const tags = [];
        if(ageInfo) tags.push(`ðŸŽ‚ ${ageInfo}`);
        if(p.phone) tags.push(`ðŸ“ž ${p.phone}`);
        if(p.status) tags.push(`ðŸ·ï¸ ${p.status}`);
        if(p.location) tags.push(`ðŸ“ ${p.location}`);
        
        tags.forEach(t => {
            const span = document.createElement('span'); span.className = 'meta-tag'; span.innerText = t;
            metaContainer.appendChild(span);
        });

        const contentDiv = document.getElementById('content');
        contentDiv.innerHTML = p.notes || "";
        contentDiv.contentEditable = "true";
        
        document.getElementById('richToolbar').style.display = "flex";
        document.querySelector('.back-btn').style.display = 'flex';
        document.getElementById('galleryContainer').style.display = "flex";
        
        document.body.classList.add('view-active');
        renderList();
        renderGallery();
    }

    // --- RICH TEXT ---
    function updateNotes() { if(activeId) db.patients[activeId].notes = document.getElementById('content').innerHTML; }
    function fmt(cmd, val=null) { document.execCommand(cmd, false, val); document.getElementById('content').focus(); }
    function addLink() { const url = prompt("URL:"); if(url) fmt('createLink', url); }
    function addVisitTemplate() {
        if(!activeId) return;
        const dateStr = new Date().toLocaleString('pl-PL');
        document.getElementById('content').innerHTML += `<br><hr><b>SESJA: ${dateStr}</b><br><span style="color:var(--txt-muted)">Stan:</span><br><br><span style="color:var(--txt-muted)">DziaÅ‚ania:</span><br><br>`;
        updateNotes();
        const div = document.getElementById('content'); div.scrollTop = div.scrollHeight;
    }

    // --- EDYCJA MODAL ---
    function openEditModal() {
        if(!activeId) return;
        const p = db.patients[activeId];
        document.getElementById('editName').value = p.name;
        document.getElementById('editDob').value = p.dob || "";
        document.getElementById('editStatus').value = p.status || "Aktywny";
        document.getElementById('editAddress').value = p.address || "";
        document.getElementById('editPhone').value = p.phone || "";
        document.getElementById('editEmail').value = p.email || "";
        document.getElementById('editLocation').value = p.location || "";
        document.getElementById('editOnline').checked = p.isOnline || false;
        document.getElementById('editModal').style.display = 'flex';
    }
    function closeEditModal() { document.getElementById('editModal').style.display = 'none'; }
    function savePatientDetails() {
        if(!activeId) return;
        const p = db.patients[activeId];
        p.name = document.getElementById('editName').value;
        p.dob = document.getElementById('editDob').value;
        p.status = document.getElementById('editStatus').value;
        p.address = document.getElementById('editAddress').value;
        p.phone = document.getElementById('editPhone').value;
        p.email = document.getElementById('editEmail').value;
        p.location = document.getElementById('editLocation').value;
        p.isOnline = document.getElementById('editOnline').checked;
        closeEditModal();
        // OdÅ›wieÅ¼ widok bez zmiany historii
        document.getElementById('activePatientName').innerText = p.name;
        renderList();
        saveToDisk();
    }

    function exitView(updateHistory = false) {
        document.body.classList.remove('view-active');
        activeId = null;
        
        const contentDiv = document.getElementById('content');
        contentDiv.contentEditable = "false";
        contentDiv.innerHTML = "";
        
        document.getElementById('activePatientName').innerText = "Wybierz pacjenta";
        document.getElementById('patientMetaDisplay').innerHTML = "";
        
        document.getElementById('richToolbar').style.display = "none";
        document.querySelector('.back-btn').style.display = 'none';
        document.getElementById('galleryContainer').style.display = "none";
        document.getElementById('viewCalendar').classList.remove('active');
        document.getElementById('viewEditor').style.display = "flex";
        renderList();
        
        // JeÅ›li funkcja wywoÅ‚ana rÄ™cznie (nie przez przycisk wstecz),
        // musimy cofnÄ…Ä‡ siÄ™ w historii, aby usunÄ…Ä‡ stan #patient
        if(updateHistory) {
             history.back();
        }
    }

    // --- ZDJÄ˜CIA (Z POPRAWKÄ„ KOMPRESJI) ---
    function uploadImg(e) {
        if(!activeId || !e.target.files[0]) return;
        const reader = new FileReader();
        reader.onload = evt => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                // Silna kompresja rozmiaru
                const MAX_DIM = 800; 
                let w = img.width, h = img.height;
                if (w > h) { if (w > MAX_DIM) { h *= MAX_DIM / w; w = MAX_DIM; } } 
                else { if (h > MAX_DIM) { w *= MAX_DIM / h; h = MAX_DIM; } }

                canvas.width = w; canvas.height = h;
                canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                
                // Silna kompresja jakoÅ›ci (JPEG 0.5)
                const data = canvas.toDataURL('image/jpeg', 0.5);
                db.patients[activeId].images.push(data);
                renderGallery();
                saveToDisk();
            };
            img.src = evt.target.result;
        };
        reader.readAsDataURL(e.target.files[0]);
    }

    function renderGallery() {
        const list = document.getElementById('galleryList');
        list.innerHTML = "";
        if(!activeId) return;
        db.patients[activeId].images.forEach((src, i) => {
            const wrap = document.createElement('div'); wrap.className = 'thumb-wrap';
            const img = document.createElement('img'); img.className = 'thumb'; img.src = src;
            img.onclick = () => { document.getElementById('imgFull').src = src; document.getElementById('imgModal').style.display = 'flex'; };
            const del = document.createElement('div'); del.className = 'thumb-del'; del.innerText = 'Ã—';
            del.onclick = (e) => { e.stopPropagation(); if(confirm("UsunÄ…Ä‡ obraz?")) { db.patients[activeId].images.splice(i, 1); renderGallery(); saveToDisk(); }};
            wrap.append(img, del); list.appendChild(wrap);
        });
    }

    // --- KALENDARZ (Z KOLOREM) ---
    function switchTab(t) {
        if(t === 'calendar') {
            document.getElementById('viewEditor').style.display = 'none';
            document.getElementById('viewCalendar').classList.add('active');
            document.body.classList.add('view-active');
            renderCalendar();
        } else {
            document.getElementById('viewCalendar').classList.remove('active');
            document.getElementById('viewEditor').style.display = 'flex';
            if(!activeId) document.body.classList.remove('view-active');
        }
    }

    function renderCalendar() {
        const date = document.getElementById('calDate').value;
        const con = document.getElementById('timeSlots');
        con.innerHTML = "";
        if(!db.calendar[date]) db.calendar[date] = {};
        
        for(let h=8; h<=20; h++) {
            const t = (h<10?'0'+h:h)+":00";
            const row = document.createElement('div'); 
            row.className = 'time-slot';
            
            // SprawdÅº czy termin jest zajÄ™ty
            const isBooked = !!db.calendar[date][t];
            if(isBooked) {
                row.classList.add('booked'); // Dodaj klasÄ™ CSS (zielone tÅ‚o)
            }

            const sel = document.createElement('select'); 
            sel.innerHTML = `<option value="">-- WOLNE --</option>`;
            // JeÅ›li zajÄ™te, tÅ‚o selecta przezroczyste by byÅ‚o widaÄ‡ kolor wiersza
            if(isBooked) sel.style.backgroundColor = 'transparent';

            Object.keys(db.patients).forEach(pid => {
                const o = document.createElement('option'); o.value = pid; o.innerText = db.patients[pid].name;
                if(db.calendar[date][t] === pid) o.selected = true;
                sel.appendChild(o);
            });
            sel.onchange = e => { db.calendar[date][t] = e.target.value; saveToDisk(); renderCalendar(); }; // Re-render dla koloru
            
            row.innerHTML = `<div class="time-label" style="width:70px; font-weight:bold;">${t}</div>`; 
            row.appendChild(sel);
            con.appendChild(row);
        }
    }
</script>
</body>
</html>
