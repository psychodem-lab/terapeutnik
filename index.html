<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Klinika - Dokumentacja E2EE (Pro)</title>
    
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23059669'%3E%3Cpath d='M20 6h-4V4c0-1.103-.897-2-2-2h-4c-1.103 0-2 .897-2 2v2H4c-1.103 0-2 .897-2 2v12c0 1.103.897 2 2 2h16c1.103 0 2-.897 2-2V8c0-1.103-.897-2-2-2zm-10-2h4v2h-4V4zm-6 4h16v3H4V8zm0 12v-7h16l.001 7H4z'/%3E%3C/svg%3E" type="image/svg+xml">

    <style>
        :root { 
            --p: #059669; /* Medyczna, spokojna ziele */
            --p-light: rgba(5, 150, 105, 0.15);
            --bg: #f1f5f9; 
            --card-bg: #ffffff;
            --txt: #1e293b; 
            --txt-muted: #64748b;
            --border: #cbd5e1;
            --input-bg: #ffffff;
            --danger: #ef4444;
        }

        @media (prefers-color-scheme: dark) {
            :root { 
                --bg: #0f172a;
                --card-bg: #1e293b;
                --txt: #f8fafc; 
                --txt-muted: #94a3b8;
                --border: #334155;
                --input-bg: #0f172a;
            }
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg); color: var(--txt); 
            padding: 20px; display: flex; justify-content: center; margin: 0;
            min-height: 100vh; box-sizing: border-box;
            transition: background-color 0.3s, color 0.3s;
        }
        
        .layout { display: flex; gap: 20px; width: 100%; max-width: 1400px; transition: all 0.3s ease; }
        
        /* Sidebar */
        .sidebar { width: 320px; flex-shrink: 0; display: flex; flex-direction: column; gap: 15px; }
        .card { background: var(--card-bg); padding: 18px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border: 1px solid var(--border); }

        /* Main Area */
        .main-area { flex-grow: 1; display: flex; flex-direction: column; gap: 15px; }
        
        .tabs { display: flex; gap: 10px; }
        .tab-btn { flex: 1; background: var(--card-bg); color: var(--txt-muted); border: 1px solid var(--border); border-bottom: 3px solid transparent; font-weight: 600; cursor: pointer; height: 48px; border-radius: 12px 12px 0 0; transition: all 0.2s; }
        .tab-btn.active { color: var(--p); border-bottom-color: var(--p); background: var(--card-bg); }

        .editor-container { flex-grow: 1; display: none; flex-direction: column; background: var(--card-bg); border-radius: 0 12px 12px 12px; border: 1px solid var(--border); overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
        .editor-container.active { display: flex; }
        
        .patient-header { padding: 15px 20px; border-bottom: 1px solid var(--border); background: var(--p-light); display: flex; justify-content: space-between; align-items: center; }
        .patient-header h2 { margin: 0; font-size: 18px; color: var(--p); }

        label { display: block; font-size: 12px; font-weight: 700; color: var(--txt-muted); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
        
        input, textarea, select, button { border-radius: 8px; border: 1px solid var(--border); background: var(--input-bg); color: var(--txt); padding: 10px 12px; box-sizing: border-box; font-size: 15px; margin-bottom: 12px; outline: none; transition: all 0.2s; width: 100%; }
        input:focus, textarea:focus, select:focus { border-color: var(--p); box-shadow: 0 0 0 3px var(--p-light); }
        
        button { background: var(--p); color: white; border: none; font-weight: 600; cursor: pointer; height: 44px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        button:active { transform: scale(0.98); }
        button.secondary { background: transparent; color: var(--txt); border: 1px solid var(--border); }
        button.secondary:hover { background: var(--input-bg); }
        button.action { background: #3b82f6; }
        
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px; }
        
        textarea { flex-grow: 1; border: none; font-family: "SF Mono", Consolas, monospace; resize: none; padding: 20px; font-size: 16px; line-height: 1.6; margin-bottom: 0; background: transparent; min-height: 300px; }
        
        .status { padding: 8px; border-radius: 6px; text-align: center; display: none; font-size: 13px; font-weight: 600; margin-top: 5px; }

        /* Lista Pacjent贸w */
        .patient-list { max-height: 400px; overflow-y: auto; margin-top: 10px; }
        .patient-item { cursor: pointer; padding: 10px; border-radius: 6px; margin-bottom: 4px; border-left: 3px solid transparent; transition: all 0.2s; font-weight: 600; font-size: 14px; }
        .patient-item:hover { background: var(--input-bg); }
        .patient-item.active { border-left-color: var(--p); background: var(--p-light); color: var(--p); }

        /* Galeria Zdj */
        .gallery-container { padding: 15px 20px; border-top: 1px solid var(--border); background: var(--input-bg); }
        .gallery { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
        .img-thumb { width: 80px; height: 80px; object-fit: cover; border-radius: 6px; cursor: pointer; border: 1px solid var(--border); }
        .img-thumb:hover { opacity: 0.8; }

        /* Kalendarz */
        .calendar-header { padding: 20px; border-bottom: 1px solid var(--border); }
        .calendar-grid { padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .time-slot { display: flex; align-items: center; gap: 15px; }
        .time-label { width: 60px; font-weight: bold; color: var(--txt-muted); text-align: right; }
        .time-select { flex-grow: 1; margin-bottom: 0; }

        /* Peny ekran dla zdjcia */
        #imgModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: center; }
        #imgModal img { max-width: 90%; max-height: 90%; border-radius: 8px; }

        @media (max-width: 900px) {
            .layout { flex-direction: column; }
            .sidebar { width: 100%; }
        }
    </style>
</head>
<body>

<div class="layout">
    <div class="sidebar">
        <div class="card">
            <label>Klucz Szyfrujcy AES-256</label>
            <input type="password" id="pass" placeholder="Wprowad藕 haso bazy..." autocomplete="new-password">
            
            <label style="margin-top: 10px;">Zarzdzanie Plikiem (PC)</label>
            <button class="secondary" onclick="openDbFile()" id="btnOpenAPI"> Otw贸rz plik bazy</button>
            <button onclick="saveDbFile()" id="btnSaveAPI" style="display: none;"> Zapisz zmiany w pliku</button>
            <div id="fileStatus" style="font-size: 11px; color: var(--txt-muted); text-align: center; margin-bottom: 10px;">Brak poczonego pliku</div>
            
            <details style="font-size: 13px; color: var(--txt-muted); margin-top: 15px;">
                <summary style="cursor: pointer; font-weight: bold;">Klasyczne wczytywanie (Telefony)</summary>
                <div style="margin-top: 10px;">
                    <input type="file" id="fallbackFile" accept=".enc" style="padding: 5px;">
                    <button class="secondary" onclick="decryptFallback()" style="height: 36px; font-size: 13px;"> Odszyfruj z pliku</button>
                    <button class="secondary" onclick="encryptFallback()" style="height: 36px; font-size: 13px;">猬锔 Pobierz jako kopi</button>
                </div>
            </details>
            
            <div id="msg" class="status"></div>
        </div>

        <div class="card">
            <label>Narzdzia</label>
            <button class="action" onclick="addPatient()"> Nowy Pacjent</button>
            
            <label style="margin-top: 15px;">Lista Pacjent贸w</label>
            <div class="patient-list" id="patientList">
                <div style="font-size: 12px; color: var(--txt-muted); text-align: center; padding: 20px;">
                    Otw贸rz baz, aby zobaczy list.
                </div>
            </div>
        </div>
    </div>

    <div class="main-area">
        <div class="tabs">
            <button class="tab-btn active" id="tabEditor" onclick="switchTab('editor')"> Karta Pacjenta</button>
            <button class="tab-btn" id="tabCalendar" onclick="switchTab('calendar')"> Kalendarz</button>
        </div>

        <div class="editor-container active" id="viewEditor">
            <div class="patient-header" id="patientHeader" style="display: none;">
                <h2 id="activePatientName">Wybierz lub dodaj pacjenta</h2>
                <button class="secondary" style="width: auto; height: 32px; font-size: 12px; margin: 0;" onclick="addVisit()"> Wpisz wizyt</button>
            </div>
            
            <textarea id="content" oninput="saveCurrentNote()" placeholder="Baza jest zablokowana lub 偶aden pacjent nie jest wybrany. Wczytaj plik, a nastpnie wybierz pacjenta z listy po lewej stronie." disabled></textarea>
            
            <div class="gallery-container" id="galleryContainer" style="display: none;">
                <label>Pliki / Zdjcia doczone do karty (zostan zaszyfrowane)</label>
                <input type="file" id="imgUploader" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
                <button class="secondary" style="width: auto; height: 30px; font-size: 12px; margin-bottom: 0;" onclick="document.getElementById('imgUploader').click()">+ Dodaj zdjcie (JPG/PNG)</button>
                <div class="gallery" id="patientGallery"></div>
            </div>
        </div>

        <div class="editor-container" id="viewCalendar">
            <div class="calendar-header">
                <label>Wybierz dzie</label>
                <input type="date" id="calDate" onchange="renderCalendar()" style="margin-bottom: 0; max-width: 250px;">
            </div>
            <div class="calendar-grid" id="timeSlots">
                </div>
        </div>
    </div>
</div>

<div id="imgModal" onclick="this.style.display='none'">
    <img id="imgModalSrc" src="">
</div>

<script>
    const ITER = 100000;
    let fileHandle = null;
    
    // G贸wna struktura Bazy Danych
    let db = {
        patients: {}, // { "uuid": { name: "Jan K.", notes: "...", images: ["base64..."] } }
        calendar: {}  // { "YYYY-MM-DD": { "08:00": "uuid", "09:00": "" } }
    };
    
    let activePatientId = null;

    // --- INTERFEJS I NAWIGACJA ---
    function switchTab(tab) {
        document.getElementById('tabEditor').classList.remove('active');
        document.getElementById('tabCalendar').classList.remove('active');
        document.getElementById('viewEditor').classList.remove('active');
        document.getElementById('viewCalendar').classList.remove('active');

        if(tab === 'editor') {
            document.getElementById('tabEditor').classList.add('active');
            document.getElementById('viewEditor').classList.add('active');
        } else {
            document.getElementById('tabCalendar').classList.add('active');
            document.getElementById('viewCalendar').classList.add('active');
            if(!document.getElementById('calDate').value) {
                document.getElementById('calDate').valueAsDate = new Date();
            }
            renderCalendar();
        }
    }

    // --- ZARZDZANIE PACJENTAMI ---
    function addPatient() {
        const name = prompt("Podaj inicjay, kod lub nazwisko pacjenta:");
        if (name && name.trim()) {
            const id = 'p_' + Date.now() + Math.floor(Math.random()*1000);
            db.patients[id] = { name: name.trim(), notes: "", images: [] };
            selectPatient(id);
            renderPatientList();
            switchTab('editor');
        }
    }

    function renderPatientList() {
        const list = document.getElementById('patientList');
        list.innerHTML = '';
        const patientIds = Object.keys(db.patients);
        
        if(patientIds.length === 0) {
            list.innerHTML = '<div style="font-size: 12px; color: var(--txt-muted); text-align: center; padding: 20px;">Brak pacjent贸w w bazie.</div>';
            return;
        }

        patientIds.forEach(id => {
            const el = document.createElement('div');
            el.className = 'patient-item' + (id === activePatientId ? ' active' : '');
            el.innerText = db.patients[id].name;
            el.onclick = () => selectPatient(id);
            list.appendChild(el);
        });
    }

    function selectPatient(id) {
        activePatientId = id;
        const p = db.patients[id];
        
        document.getElementById('patientHeader').style.display = 'flex';
        document.getElementById('galleryContainer').style.display = 'block';
        document.getElementById('activePatientName').innerText = p.name;
        
        const content = document.getElementById('content');
        content.disabled = false;
        content.value = p.notes || "";
        content.placeholder = "Tutaj wpisuj notatki pacjenta...";
        
        renderPatientList();
        renderGallery();
        switchTab('editor');
    }

    function saveCurrentNote() {
        if(activePatientId && db.patients[activePatientId]) {
            db.patients[activePatientId].notes = document.getElementById('content').value;
        }
    }

    function addVisit() {
        if(!activePatientId) return;
        const dateStr = new Date().toLocaleDateString('pl-PL', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
        const visitTemplate = `\n## Wizyta: ${dateStr}\n- Wywiad/Cel wizyty: \n- Przebieg: \n- Wnioski/Zalecenia: \n\n`;
        const contentArea = document.getElementById('content');
        
        const start = contentArea.selectionStart;
        contentArea.value = contentArea.value.substring(0, start) + visitTemplate + contentArea.value.substring(contentArea.selectionEnd);
        saveCurrentNote();
        contentArea.focus();
        contentArea.setSelectionRange(start + visitTemplate.length - 2, start + visitTemplate.length - 2);
    }

    // --- ZDJCIA (Base64) ---
    function handleImageUpload(e) {
        if(!activePatientId) return;
        const file = e.target.files[0];
        if(!file) return;

        const reader = new FileReader();
        reader.onload = function(event) {
            const img = new Image();
            img.onload = function() {
                // Kompresja w przegldarce przed zapisaniem w JSON
                const canvas = document.createElement('canvas');
                const MAX_WIDTH = 1000;
                let scale = 1;
                if(img.width > MAX_WIDTH) scale = MAX_WIDTH / img.width;
                
                canvas.width = img.width * scale;
                canvas.height = img.height * scale;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                
                const dataUrl = canvas.toDataURL('image/jpeg', 0.6); // Zmniejszenie jakoci do 60% dla maego wagi pliku
                
                if(!db.patients[activePatientId].images) db.patients[activePatientId].images = [];
                db.patients[activePatientId].images.push(dataUrl);
                renderGallery();
                
                // Reset inputa
                document.getElementById('imgUploader').value = '';
            }
            img.src = event.target.result;
        }
        reader.readAsDataURL(file);
    }

    function renderGallery() {
        if(!activePatientId) return;
        const gal = document.getElementById('patientGallery');
        gal.innerHTML = '';
        const images = db.patients[activePatientId].images || [];
        
        images.forEach((imgSrc, idx) => {
            const img = document.createElement('img');
            img.src = imgSrc;
            img.className = 'img-thumb';
            img.onclick = () => {
                document.getElementById('imgModalSrc').src = imgSrc;
                document.getElementById('imgModal').style.display = 'flex';
            };
            gal.appendChild(img);
        });
    }

    // --- KALENDARZ ---
    function renderCalendar() {
        const dateStr = document.getElementById('calDate').value;
        if(!dateStr) return;
        
        const slotsContainer = document.getElementById('timeSlots');
        slotsContainer.innerHTML = '';

        if(!db.calendar[dateStr]) db.calendar[dateStr] = {};

        // Godziny od 8 do 20
        for(let i = 8; i <= 20; i++) {
            const hour = (i < 10 ? '0' + i : i) + ':00';
            
            const row = document.createElement('div');
            row.className = 'time-slot';
            
            const label = document.createElement('div');
            label.className = 'time-label';
            label.innerText = hour;

            const select = document.createElement('select');
            select.className = 'time-select';
            select.innerHTML = '<option value="">-- Wolny termin --</option>';
            
            Object.keys(db.patients).forEach(pid => {
                const opt = document.createElement('option');
                opt.value = pid;
                opt.innerText = db.patients[pid].name;
                if(db.calendar[dateStr][hour] === pid) opt.selected = true;
                select.appendChild(opt);
            });

            select.onchange = (e) => {
                db.calendar[dateStr][hour] = e.target.value;
            };

            row.appendChild(label);
            row.appendChild(select);
            slotsContainer.appendChild(row);
        }
    }

    // --- KRYPTOGRAFIA I ZARZDZANIE PLIKAMI ---
    function log(m, success) {
        const e = document.getElementById('msg');
        e.innerText = m; e.style.display = 'block';
        e.style.background = success ? 'rgba(16, 185, 129, 0.15)' : 'rgba(239, 68, 68, 0.15)';
        e.style.color = success ? '#059669' : '#ef4444';
        setTimeout(() => { e.style.display = 'none'; }, 5000);
    }

    async function getKey(pw, salt) {
        const enc = new TextEncoder();
        const bKey = await crypto.subtle.importKey('raw', enc.encode(pw), 'PBKDF2', false, ['deriveKey']);
        return crypto.subtle.deriveKey(
            { name: 'PBKDF2', salt, iterations: ITER, hash: 'SHA-256' },
            bKey, { name: 'AES-GCM', length: 256 }, false, ['encrypt', 'decrypt']
        );
    }

    async function processEncryption(pw) {
        // Konwertujemy cay obiekt DB do stringa JSON przed zaszyfrowaniem
        const dataString = JSON.stringify(db);
        const salt = crypto.getRandomValues(new Uint8Array(16));
        const iv = crypto.getRandomValues(new Uint8Array(12));
        const key = await getKey(pw, salt);
        const cipher = await crypto.subtle.encrypt({name: 'AES-GCM', iv}, key, new TextEncoder().encode(dataString));
        const combined = new Uint8Array(16 + 12 + cipher.byteLength);
        combined.set(salt, 0); combined.set(iv, 16); combined.set(new Uint8Array(cipher), 28);
        return combined;
    }

    async function processDecryption(buffer, pw) {
        const buf = new Uint8Array(buffer);
        const key = await getKey(pw, buf.slice(0, 16));
        const dec = await crypto.subtle.decrypt({name: 'AES-GCM', iv: buf.slice(16, 28)}, key, buf.slice(28));
        const decryptedStr = new TextDecoder().decode(dec);
        
        try {
            // Pr贸ba interpretacji jako nowy format JSON
            db = JSON.parse(decryptedStr);
            if(!db.patients) db.patients = {};
            if(!db.calendar) db.calendar = {};
        } catch(e) {
            // MIGRACJA STAREGO FORMATU (czysty tekst)
            db = { patients: {}, calendar: {} };
            if (decryptedStr.includes('# PACJENT:')) {
                const parts = decryptedStr.split(/(?=# PACJENT:)/);
                parts.forEach(p => {
                    const match = p.match(/# PACJENT:\s*(.*)/);
                    if(match) {
                        const id = 'p_' + Math.random().toString(36).substr(2, 9);
                        db.patients[id] = { name: match[1].trim(), notes: p.replace(match[0], '').trim(), images: [] };
                    }
                });
            } else {
                // Jeli nie byo formatowania # PACJENT:
                const id = 'p_migracja';
                db.patients[id] = { name: "Zaimportowane Notatki", notes: decryptedStr, images: [] };
            }
            alert("Pomylnie zmigrowano dane ze starego formatu do nowego systemu bazodanowego.");
        }

        activePatientId = null;
        document.getElementById('content').value = "";
        document.getElementById('content').disabled = true;
        document.getElementById('patientHeader').style.display = 'none';
        document.getElementById('galleryContainer').style.display = 'none';
        
        renderPatientList();
        renderCalendar();
        log("Baza wczytana pomylnie!", true);
    }

    // Zapisywanie PC (File System Access API)
    async function openDbFile() {
        const pw = document.getElementById('pass').value;
        if(!pw) return alert("Najpierw wprowad藕 klucz szyfrujcy!");
        
        try {
            if (!window.showOpenFilePicker) throw new Error("API nieobsugiwane. U偶yj klasycznego wczytywania poni偶ej.");
            [fileHandle] = await window.showOpenFilePicker({ types: [{ accept: {'application/octet-stream': ['.enc']} }] });
            const file = await fileHandle.getFile();
            document.getElementById('fileStatus').innerText = "Aktywny plik: " + file.name;
            
            await processDecryption(await file.arrayBuffer(), pw);
            
            document.getElementById('btnOpenAPI').style.display = 'none';
            document.getElementById('btnSaveAPI').style.display = 'flex';
        } catch (e) {
            if(e.name !== 'AbortError') log(e.message || "Bd wczytywania", false);
        }
    }

    async function saveDbFile() {
        if (!fileHandle) return alert("Brak poczonego pliku!");
        const pw = document.getElementById('pass').value;
        if(!pw) return alert("Brak hasa!");
        try {
            const combined = await processEncryption(pw);
            const writable = await fileHandle.createWritable();
            await writable.write(combined);
            await writable.close();
            log("Zapisano bezpiecznie na dysku!", true);
        } catch (e) { log("Bd zapisu! Sprawd藕 uprawnienia.", false); }
    }

    // Telefony (Pobieranie/Wgrywanie)
    async function encryptFallback() {
        const pw = document.getElementById('pass').value;
        if(!pw) return alert("Brak hasa!");
        try {
            const combined = await processEncryption(pw);
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([combined], {type: 'application/octet-stream'}));
            a.download = `klinika_pro_${new Date().toISOString().slice(0,10)}.enc`; 
            a.click();
            log("Pobrano plik z kopi bazy!", true);
        } catch(e) { log("Bd szyfrowania", false); }
    }

    async function decryptFallback() {
        const pw = document.getElementById('pass').value;
        const file = document.getElementById('fallbackFile').files[0];
        if(!pw || !file) return alert("Podaj klucz i wybierz plik z listy!");
        try {
            await processDecryption(await file.arrayBuffer(), pw);
            document.getElementById('fileStatus').innerText = "Wczytano statycznie: " + file.name;
        } catch(e) { log("Bd deszyfracji. Bdne haso?", false); }
    }
</script>
</body>
</html>
