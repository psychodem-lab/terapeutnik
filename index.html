<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Klinika - System Bezpiecznej Dokumentacji</title>
    
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23059669'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z'/%3E%3C/svg%3E" type="image/svg+xml">

    <style>
        :root { 
            --p: #059669; /* Primary Green */
            --p-hover: #047857;
            --p-light: rgba(5, 150, 105, 0.1);
            --bg: #f1f5f9; 
            --card-bg: #ffffff;
            --txt: #1e293b; 
            --txt-muted: #64748b;
            --border: #cbd5e1;
            --input-bg: #ffffff;
            --danger: #ef4444;
            --danger-hover: #dc2626;
        }

        @media (prefers-color-scheme: dark) {
            :root { 
                --bg: #0f172a;
                --card-bg: #1e293b;
                --txt: #f8fafc; 
                --txt-muted: #94a3b8;
                --border: #334155;
                --input-bg: #0f172a;
            }
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg); color: var(--txt); 
            margin: 0; padding: 0; min-height: 100vh;
            display: flex; justify-content: center;
        }
        
        /* --- EKRAN LOGOWANIA --- */
        #loginScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg); z-index: 5000;
            display: flex; align-items: center; justify-content: center;
            padding: 20px; box-sizing: border-box;
        }
        .login-card {
            background: var(--card-bg); width: 100%; max-width: 400px;
            padding: 30px; border-radius: 16px;
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1);
            border: 1px solid var(--border);
            text-align: center;
        }
        .login-logo {
            width: 48px; height: 48px; margin-bottom: 15px; fill: var(--p);
        }
        .login-btn-group {
            display: flex; flex-direction: column; gap: 10px; margin-top: 20px;
        }

        /* --- G≈Å√ìWNY INTERFEJS --- */
        #appLayout {
            display: none; /* Ukryte domy≈õlnie */
            gap: 20px; width: 100%; max-width: 1400px; padding: 20px; box-sizing: border-box;
        }
        
        /* Sidebar */
        .sidebar { width: 320px; flex-shrink: 0; display: flex; flex-direction: column; gap: 15px; }
        .card { background: var(--card-bg); padding: 18px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); border: 1px solid var(--border); }

        /* Main Area */
        .main-area { flex-grow: 1; display: flex; flex-direction: column; gap: 15px; }
        
        .tabs { display: flex; gap: 10px; }
        .tab-btn { flex: 1; background: var(--card-bg); color: var(--txt-muted); border: 1px solid var(--border); border-bottom: 3px solid transparent; font-weight: 600; cursor: pointer; height: 48px; border-radius: 12px 12px 0 0; transition: all 0.2s; }
        .tab-btn.active { color: var(--p); border-bottom-color: var(--p); background: var(--card-bg); }

        .editor-container { flex-grow: 1; display: none; flex-direction: column; background: var(--card-bg); border-radius: 0 12px 12px 12px; border: 1px solid var(--border); overflow: hidden; min-height: 500px; }
        .editor-container.active { display: flex; }
        
        .patient-header { padding: 15px 20px; border-bottom: 1px solid var(--border); background: var(--p-light); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;}
        .patient-header h2 { margin: 0; font-size: 18px; color: var(--p); }

        label { display: block; font-size: 12px; font-weight: 700; color: var(--txt-muted); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; text-align: left;}
        
        input, textarea, select, button { border-radius: 8px; border: 1px solid var(--border); background: var(--input-bg); color: var(--txt); padding: 10px 12px; box-sizing: border-box; font-size: 15px; margin-bottom: 12px; outline: none; transition: all 0.2s; width: 100%; }
        input:focus, textarea:focus, select:focus { border-color: var(--p); box-shadow: 0 0 0 3px var(--p-light); }
        
        button { background: var(--p); color: white; border: none; font-weight: 600; cursor: pointer; height: 44px; display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 0; }
        button:hover { background: var(--p-hover); }
        button:active { transform: scale(0.98); }
        
        button.secondary { background: transparent; color: var(--txt); border: 1px solid var(--border); }
        button.secondary:hover { background: var(--input-bg); }
        
        button.danger { background: var(--danger); color: white; border: none; }
        button.danger:hover { background: var(--danger-hover); }

        button.action { background: #3b82f6; }
        button.action:hover { background: #2563eb; }
        
        textarea { flex-grow: 1; border: none; font-family: "SF Mono", Consolas, monospace; resize: none; padding: 20px; font-size: 16px; line-height: 1.6; margin-bottom: 0; background: transparent; min-height: 300px; }
        
        .status { padding: 10px; border-radius: 6px; text-align: center; display: none; font-size: 13px; font-weight: 600; margin-top: 10px; }

        /* Lista Pacjent√≥w */
        .patient-list { max-height: 500px; overflow-y: auto; margin-top: 10px; }
        .patient-item { cursor: pointer; padding: 10px; border-radius: 6px; margin-bottom: 4px; border-left: 3px solid transparent; transition: all 0.2s; font-weight: 600; font-size: 14px; display: flex; justify-content: space-between; align-items: center;}
        .patient-item:hover { background: var(--input-bg); }
        .patient-item.active { border-left-color: var(--p); background: var(--p-light); color: var(--p); }

        /* Galeria Zdjƒôƒá */
        .gallery-container { padding: 15px 20px; border-top: 1px solid var(--border); background: var(--input-bg); }
        .gallery { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
        
        .img-wrapper { position: relative; width: 80px; height: 80px; }
        .img-thumb { width: 100%; height: 100%; object-fit: cover; border-radius: 6px; cursor: pointer; border: 1px solid var(--border); }
        .img-thumb:hover { opacity: 0.8; }
        .img-delete { position: absolute; top: -6px; right: -6px; background: var(--danger); color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; justify-content: center; align-items: center; font-size: 12px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2); border: 2px solid var(--card-bg); }

        /* Kalendarz */
        .calendar-header { padding: 20px; border-bottom: 1px solid var(--border); }
        .calendar-grid { padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .time-slot { display: flex; align-items: center; gap: 15px; }
        .time-label { width: 60px; font-weight: bold; color: var(--txt-muted); text-align: right; }
        .time-select { flex-grow: 1; margin-bottom: 0; }

        /* Pe≈Çny ekran */
        #imgModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 6000; justify-content: center; align-items: center; }
        #imgModal img { max-width: 90%; max-height: 90%; border-radius: 8px; }

        /* Responsywno≈õƒá */
        @media (max-width: 900px) {
            #appLayout { flex-direction: column; padding: 10px; }
            .sidebar { width: 100%; }
            .patient-header { flex-direction: column; align-items: stretch; }
            .patient-header button { width: 100%; margin-top: 5px; }
        }
    </style>
</head>
<body>

<div id="loginScreen">
    <div class="login-card">
        <svg class="login-logo" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 14h-2v-2h2v2zm0-4h-2V7h2v5z"/></svg>
        <h2 style="margin-top:0;">Terapeutnik Pro</h2>
        <p style="color: var(--txt-muted); font-size: 14px;">Zaloguj siƒô, aby odszyfrowaƒá bazƒô pacjent√≥w lub utw√≥rz nowƒÖ.</p>
        
        <div style="text-align: left; margin-top: 20px;">
            <label>Nazwa U≈ºytkownika</label>
            <input type="text" id="loginUser" placeholder="Np. jan_kowalski" autocomplete="username">
            
            <label>Has≈Ço SzyfrujƒÖce</label>
            <input type="password" id="loginPass" placeholder="Wprowad≈∫ has≈Ço..." autocomplete="current-password">
        </div>

        <div class="login-btn-group">
            <button onclick="handleLogin('open')">üìÇ Otw√≥rz IstniejƒÖcƒÖ Bazƒô</button>
            <button class="secondary" onclick="handleLogin('create')">‚ú® Utw√≥rz NowƒÖ Bazƒô</button>
        </div>
        
        <div id="loginStatus" class="status"></div>
        <div style="font-size: 11px; color: var(--txt-muted); margin-top: 15px;">
            Obs≈Çugiwane pliki: <strong>.json</strong> (Szyfrowane AES-256)
        </div>
    </div>
</div>

<div class="layout" id="appLayout">
    <div class="sidebar">
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <label style="margin:0;">Zalogowano jako:</label>
                <button class="secondary" style="width: auto; height: 24px; font-size: 10px; padding: 0 8px;" onclick="location.reload()">WYLOGUJ</button>
            </div>
            <div id="currentUserDisplay" style="font-weight: bold; color: var(--p); font-size: 16px; margin-bottom: 15px;">...</div>

            <label>ZarzƒÖdzanie Plikiem</label>
            <button onclick="saveDbFile()" id="btnSave" class="secondary">üíæ Zapisz zmiany (JSON)</button>
            <div id="fileInfo" style="font-size: 11px; color: var(--txt-muted); text-align: center; margin-top: 5px;"></div>
            <div id="appMsg" class="status"></div>
        </div>

        <div class="card">
            <label>Narzƒôdzia</label>
            <button class="action" onclick="addPatient()">üë§ Nowy Pacjent</button>
            
            <label style="margin-top: 15px;">Lista Pacjent√≥w</label>
            <div class="patient-list" id="patientList"></div>
        </div>
    </div>

    <div class="main-area">
        <div class="tabs">
            <button class="tab-btn active" id="tabEditor" onclick="switchTab('editor')">üìù Karta Pacjenta</button>
            <button class="tab-btn" id="tabCalendar" onclick="switchTab('calendar')">üìÖ Kalendarz</button>
        </div>

        <div class="editor-container active" id="viewEditor">
            <div class="patient-header" id="patientHeader" style="display: none;">
                <div style="display:flex; align-items: center; gap: 10px;">
                    <h2 id="activePatientName">Pacjent</h2>
                </div>
                <div style="display:flex; gap: 8px;">
                    <button class="secondary" style="width: auto; height: 32px; font-size: 12px;" onclick="addVisit()">üìù Nowa Wizyta</button>
                    <button class="danger" style="width: auto; height: 32px; font-size: 12px;" onclick="deleteCurrentPatient()">üóëÔ∏è Usu≈Ñ Pacjenta</button>
                </div>
            </div>
            
            <textarea id="content" oninput="saveCurrentNote()" placeholder="Wybierz pacjenta z listy po lewej stronie, aby edytowaƒá notatki." disabled></textarea>
            
            <div class="gallery-container" id="galleryContainer" style="display: none;">
                <label>Za≈ÇƒÖczniki (Szyfrowane)</label>
                <input type="file" id="imgUploader" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
                
                <button class="secondary" style="width: auto; height: 30px; font-size: 12px;" onclick="document.getElementById('imgUploader').click()">+ Dodaj zdjƒôcie</button>
                <div class="gallery" id="patientGallery"></div>
            </div>
        </div>

        <div class="editor-container" id="viewCalendar">
            <div class="calendar-header">
                <label>Wybierz dzie≈Ñ</label>
                <input type="date" id="calDate" onchange="renderCalendar()" style="margin-bottom: 0; max-width: 250px;">
            </div>
            <div class="calendar-grid" id="timeSlots"></div>
        </div>
    </div>
</div>

<div id="imgModal" onclick="this.style.display='none'">
    <img id="imgModalSrc" src="">
</div>

<script>
    const ITER = 100000; // Iteracje PBKDF2 dla bezpiecze≈Ñstwa
    let db = { patients: {}, calendar: {} };
    let activePatientId = null;
    let fileHandle = null;
    let currentUsername = "";
    let currentPassword = ""; // Przechowywane w pamiƒôci tylko na czas sesji

    // --- LOGIKA LOGOWANIA I PLIK√ìW ---

    async function handleLogin(mode) {
        const user = document.getElementById('loginUser').value.trim();
        const pass = document.getElementById('loginPass').value;
        const status = document.getElementById('loginStatus');

        if (!user || !pass) {
            showStatus(status, "Podaj nazwƒô u≈ºytkownika i has≈Ço!", false);
            return;
        }

        currentUsername = user;
        currentPassword = pass;

        if (mode === 'create') {
            // TWORZENIE NOWEJ BAZY
            db = { patients: {}, calendar: {} };
            try {
                if(window.showSaveFilePicker) {
                    const opts = {
                        suggestedName: `${user}.json`,
                        types: [{ description: 'Baza Terapeutnik', accept: {'application/json': ['.json']} }],
                    };
                    fileHandle = await window.showSaveFilePicker(opts);
                    await saveToDisk();
                    enterApp();
                } else {
                    // Fallback dla braku API
                    downloadFallback();
                    enterApp();
                }
            } catch (e) {
                if(e.name !== 'AbortError') showStatus(status, "B≈ÇƒÖd tworzenia pliku.", false);
            }
        } else {
            // OTWIERANIE ISTNIEJƒÑCEJ
            try {
                let fileData;
                if(window.showOpenFilePicker) {
                    [fileHandle] = await window.showOpenFilePicker({
                        types: [{ description: 'Baza JSON', accept: {'application/json': ['.json']} }]
                    });
                    const file = await fileHandle.getFile();
                    document.getElementById('fileInfo').innerText = file.name;
                    fileData = await file.text();
                } else {
                    // Fallback input
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = '.json';
                    input.onchange = async e => {
                        const file = e.target.files[0];
                        if(file) {
                            document.getElementById('fileInfo').innerText = file.name;
                            const text = await file.text();
                            await processLoad(text, status);
                        }
                    };
                    input.click();
                    return; // Czekamy na event onchange
                }

                if(fileData) await processLoad(fileData, status);

            } catch (e) {
                if(e.name !== 'AbortError') {
                    console.error(e);
                    showStatus(status, "B≈ÇƒÖd odczytu pliku.", false);
                }
            }
        }
    }

    async function processLoad(jsonString, statusElem) {
        try {
            const encryptedObj = JSON.parse(jsonString);
            
            // Opcjonalne sprawdzenie w≈Ça≈õciciela pliku (je≈õli zapisano w metadanych)
            if(encryptedObj.username && encryptedObj.username !== currentUsername) {
                if(!confirm(`Uwaga! Plik nale≈ºy do u≈ºytkownika "${encryptedObj.username}", a logujesz siƒô jako "${currentUsername}". Kontynuowaƒá?`)) {
                    return;
                }
            }

            // Odszyfrowanie
            const decryptedJson = await decryptData(encryptedObj, currentPassword);
            db = JSON.parse(decryptedJson);
            
            // Naprawa struktury je≈õli pusta
            if(!db.patients) db.patients = {};
            if(!db.calendar) db.calendar = {};

            enterApp();
        } catch (e) {
            console.error(e);
            showStatus(statusElem, "B≈ÅƒòDNE HAS≈ÅO lub uszkodzony plik!", false);
        }
    }

    function enterApp() {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('appLayout').style.display = 'flex';
        document.getElementById('currentUserDisplay').innerText = currentUsername;
        renderPatientList();
        renderCalendar();
    }

    // --- KRYPTOGRAFIA (AES-GCM w JSON Wrapper) ---
    
    // Helpers do konwersji Buffer <-> Base64
    function buffToBase64(buff) {
        return btoa(String.fromCharCode.apply(null, new Uint8Array(buff)));
    }
    function base64ToBuff(b64) {
        return Uint8Array.from(atob(b64), c => c.charCodeAt(0));
    }

    async function getKey(pw, salt) {
        const enc = new TextEncoder();
        const bKey = await crypto.subtle.importKey('raw', enc.encode(pw), 'PBKDF2', false, ['deriveKey']);
        return crypto.subtle.deriveKey(
            { name: 'PBKDF2', salt: salt, iterations: ITER, hash: 'SHA-256' },
            bKey, { name: 'AES-GCM', length: 256 }, false, ['encrypt', 'decrypt']
        );
    }

    async function encryptData(dataStr, pw) {
        const salt = crypto.getRandomValues(new Uint8Array(16));
        const iv = crypto.getRandomValues(new Uint8Array(12));
        const key = await getKey(pw, salt);
        const encoded = new TextEncoder().encode(dataStr);
        
        const ciphertext = await crypto.subtle.encrypt({name: 'AES-GCM', iv: iv}, key, encoded);

        return {
            username: currentUsername, // Metadane jawne
            salt: buffToBase64(salt),
            iv: buffToBase64(iv),
            data: buffToBase64(ciphertext)
        };
    }

    async function decryptData(wrapperObj, pw) {
        const salt = base64ToBuff(wrapperObj.salt);
        const iv = base64ToBuff(wrapperObj.iv);
        const data = base64ToBuff(wrapperObj.data);
        
        const key = await getKey(pw, salt);
        const decryptedInfo = await crypto.subtle.decrypt({name: 'AES-GCM', iv: iv}, key, data);
        
        return new TextDecoder().decode(decryptedInfo);
    }

    // --- ZAPISYWANIE ---

    async function saveToDisk() {
        const msg = document.getElementById('appMsg');
        try {
            const jsonStr = JSON.stringify(db);
            const encryptedWrapper = await encryptData(jsonStr, currentPassword);
            const finalFileContent = JSON.stringify(encryptedWrapper, null, 2);

            if (fileHandle) {
                const writable = await fileHandle.createWritable();
                await writable.write(finalFileContent);
                await writable.close();
                showStatus(msg, "Zapisano zmiany w pliku JSON.", true);
            } else {
                // Fallback download
                const blob = new Blob([finalFileContent], {type: "application/json"});
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `${currentUsername}_baza.json`;
                a.click();
                showStatus(msg, "Pobrano nowƒÖ wersjƒô pliku.", true);
            }
        } catch (e) {
            showStatus(msg, "B≈ÇƒÖd zapisu! " + e.message, false);
        }
    }
    
    // Alias dla przycisku w menu
    function saveDbFile() { saveToDisk(); }
    function downloadFallback() { saveToDisk(); }

    // --- ZARZƒÑDZANIE PACJENTAMI ---

    function addPatient() {
        const name = prompt("Podaj inicja≈Çy lub identyfikator pacjenta:");
        if (name && name.trim()) {
            const id = 'p_' + Date.now();
            db.patients[id] = { name: name.trim(), notes: "", images: [] };
            selectPatient(id);
            renderPatientList();
            switchTab('editor');
            saveToDisk(); // Autosave struktury
        }
    }

    function deleteCurrentPatient() {
        if(!activePatientId) return;
        if(confirm(`Czy na pewno chcesz usunƒÖƒá pacjenta "${db.patients[activePatientId].name}"?\nTej operacji nie mo≈ºna cofnƒÖƒá!`)) {
            // Usu≈Ñ z kalendarza
            for(let date in db.calendar) {
                for(let hour in db.calendar[date]) {
                    if(db.calendar[date][hour] === activePatientId) {
                        delete db.calendar[date][hour];
                    }
                }
            }
            // Usu≈Ñ z bazy
            delete db.patients[activePatientId];
            
            // Reset widoku
            activePatientId = null;
            document.getElementById('content').value = "";
            document.getElementById('content').disabled = true;
            document.getElementById('patientHeader').style.display = 'none';
            document.getElementById('galleryContainer').style.display = 'none';
            
            renderPatientList();
            renderCalendar(); // Od≈õwie≈º by usunƒÖƒá wpisy w kalendarzu
            saveToDisk();
        }
    }

    function renderPatientList() {
        const list = document.getElementById('patientList');
        list.innerHTML = '';
        const patientIds = Object.keys(db.patients);
        
        if(patientIds.length === 0) {
            list.innerHTML = '<div style="font-size: 12px; color: var(--txt-muted); text-align: center; padding: 20px;">Brak pacjent√≥w.</div>';
            return;
        }

        patientIds.forEach(id => {
            const el = document.createElement('div');
            el.className = 'patient-item' + (id === activePatientId ? ' active' : '');
            
            const nameSpan = document.createElement('span');
            nameSpan.innerText = db.patients[id].name;
            el.appendChild(nameSpan);
            
            // Onclick na ca≈Çy element
            el.onclick = () => selectPatient(id);
            
            list.appendChild(el);
        });
    }

    function selectPatient(id) {
        activePatientId = id;
        const p = db.patients[id];
        
        document.getElementById('patientHeader').style.display = 'flex';
        document.getElementById('galleryContainer').style.display = 'block';
        document.getElementById('activePatientName').innerText = p.name;
        
        const content = document.getElementById('content');
        content.disabled = false;
        content.value = p.notes || "";
        
        renderPatientList();
        renderGallery();
        switchTab('editor');
    }

    function saveCurrentNote() {
        if(activePatientId && db.patients[activePatientId]) {
            db.patients[activePatientId].notes = document.getElementById('content').value;
        }
    }

    function addVisit() {
        if(!activePatientId) return;
        const dateStr = new Date().toLocaleDateString('pl-PL', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
        const visitTemplate = `\n----------------------------------------\nüìÖ WIZYTA: ${dateStr}\n\n1. Obserwacje / Wywiad:\n   \n\n2. Interwencje / Przebieg:\n   \n\n3. Zalecenia / Plan:\n   \n`;
        const contentArea = document.getElementById('content');
        const start = contentArea.selectionStart;
        
        // Wstaw na poczƒÖtku lub w miejscu kursora? Zwykle na ko≈Ñcu jest wygodniej, ale tutaj w miejscu kursora.
        const newVal = contentArea.value.substring(0, start) + visitTemplate + contentArea.value.substring(contentArea.selectionEnd);
        contentArea.value = newVal;
        
        saveCurrentNote();
        contentArea.focus();
    }

    // --- ZDJƒòCIA ---

    function handleImageUpload(e) {
        if(!activePatientId) return;
        const file = e.target.files[0];
        if(!file) return;

        const reader = new FileReader();
        reader.onload = function(event) {
            const img = new Image();
            img.onload = function() {
                // Kompresja
                const canvas = document.createElement('canvas');
                const MAX_WIDTH = 1000;
                let scale = 1;
                if(img.width > MAX_WIDTH) scale = MAX_WIDTH / img.width;
                canvas.width = img.width * scale;
                canvas.height = img.height * scale;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                const dataUrl = canvas.toDataURL('image/jpeg', 0.6); 
                
                if(!db.patients[activePatientId].images) db.patients[activePatientId].images = [];
                db.patients[activePatientId].images.push(dataUrl);
                renderGallery();
                saveToDisk(); // Save po dodaniu zdjƒôcia
                
                document.getElementById('imgUploader').value = '';
            }
            img.src = event.target.result;
        }
        reader.readAsDataURL(file);
    }

    function deleteImage(index) {
        if(!activePatientId) return;
        if(confirm("UsunƒÖƒá to zdjƒôcie?")) {
            db.patients[activePatientId].images.splice(index, 1);
            renderGallery();
            saveToDisk();
        }
    }

    function renderGallery() {
        if(!activePatientId) return;
        const gal = document.getElementById('patientGallery');
        gal.innerHTML = '';
        const images = db.patients[activePatientId].images || [];
        
        images.forEach((imgSrc, idx) => {
            const wrapper = document.createElement('div');
            wrapper.className = 'img-wrapper';

            const img = document.createElement('img');
            img.src = imgSrc;
            img.className = 'img-thumb';
            img.onclick = () => {
                document.getElementById('imgModalSrc').src = imgSrc;
                document.getElementById('imgModal').style.display = 'flex';
            };

            const delBtn = document.createElement('div');
            delBtn.className = 'img-delete';
            delBtn.innerHTML = '‚úï';
            delBtn.onclick = (e) => { e.stopPropagation(); deleteImage(idx); };

            wrapper.appendChild(img);
            wrapper.appendChild(delBtn);
            gal.appendChild(wrapper);
        });
    }

    // --- KALENDARZ I INTERFEJS ---

    function renderCalendar() {
        const dateStr = document.getElementById('calDate').value || new Date().toISOString().split('T')[0];
        document.getElementById('calDate').value = dateStr;
        
        const slotsContainer = document.getElementById('timeSlots');
        slotsContainer.innerHTML = '';

        if(!db.calendar[dateStr]) db.calendar[dateStr] = {};

        for(let i = 8; i <= 20; i++) {
            const hour = (i < 10 ? '0' + i : i) + ':00';
            const row = document.createElement('div');
            row.className = 'time-slot';
            
            const label = document.createElement('div');
            label.className = 'time-label';
            label.innerText = hour;

            const select = document.createElement('select');
            select.className = 'time-select';
            select.innerHTML = '<option value="">-- Wolny termin --</option>';
            
            // Sortowanie pacjent√≥w alfabetycznie w select
            const sortedIds = Object.keys(db.patients).sort((a,b) => db.patients[a].name.localeCompare(db.patients[b].name));
            
            sortedIds.forEach(pid => {
                const opt = document.createElement('option');
                opt.value = pid;
                opt.innerText = db.patients[pid].name;
                if(db.calendar[dateStr][hour] === pid) opt.selected = true;
                select.appendChild(opt);
            });

            select.onchange = (e) => {
                db.calendar[dateStr][hour] = e.target.value;
                saveToDisk(); // Save po zmianie kalendarza
            };

            row.appendChild(label);
            row.appendChild(select);
            slotsContainer.appendChild(row);
        }
    }

    function switchTab(tab) {
        document.getElementById('tabEditor').classList.remove('active');
        document.getElementById('tabCalendar').classList.remove('active');
        document.getElementById('viewEditor').classList.remove('active');
        document.getElementById('viewCalendar').classList.remove('active');

        if(tab === 'editor') {
            document.getElementById('tabEditor').classList.add('active');
            document.getElementById('viewEditor').classList.add('active');
        } else {
            document.getElementById('tabCalendar').classList.add('active');
            document.getElementById('viewCalendar').classList.add('active');
            renderCalendar();
        }
    }

    function showStatus(elem, msg, success) {
        elem.innerText = msg; 
        elem.style.display = 'block';
        elem.style.background = success ? 'var(--p-light)' : 'rgba(239, 68, 68, 0.1)';
        elem.style.color = success ? 'var(--p)' : 'var(--danger)';
        setTimeout(() => { elem.style.display = 'none'; }, 4000);
    }

    // Inicjalizacja daty przy starcie
    document.getElementById('calDate').valueAsDate = new Date();

</script>
</body>
</html>
