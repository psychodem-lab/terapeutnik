<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Terapeutnik Pro 3.0</title>
    
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23059669'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z'/%3E%3C/svg%3E" type="image/svg+xml">

    <style>
        /* --- ZMIENNE KOLORYSTYCZNE (Dzie≈Ñ / Noc) --- */
        :root {
            --trans-speed: 0.3s;
        }

        /* Domy≈õlny (Light Mode) - Jasny, czysty, medyczny */
        [data-theme="light"] {
            --bg: #f8fafc;
            --sidebar-bg: #ffffff;
            --card-bg: #ffffff;
            --txt: #334155;
            --txt-head: #0f172a;
            --txt-muted: #64748b;
            --border: #e2e8f0;
            --input-bg: #f1f5f9;
            --p: #059669; /* Primary Green */
            --p-hover: #047857;
            --p-light: #d1fae5;
            --danger: #ef4444;
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
        }

        /* Dark Mode - G≈Çƒôboki, kontrastowy */
        [data-theme="dark"] {
            --bg: #0f172a;
            --sidebar-bg: #1e293b;
            --card-bg: #1e293b;
            --txt: #e2e8f0;
            --txt-head: #f8fafc;
            --txt-muted: #94a3b8;
            --border: #334155;
            --input-bg: #020617;
            --p: #10b981;
            --p-hover: #059669;
            --p-light: rgba(16, 185, 129, 0.15);
            --danger: #f87171;
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.3);
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg); color: var(--txt); 
            margin: 0; padding: 0; height: 100vh; overflow: hidden;
            transition: background var(--trans-speed), color var(--trans-speed);
        }
        
        button { cursor: pointer; font-family: inherit; }
        
        /* --- LAYOUT G≈Å√ìWNY --- */
        #appLayout {
            display: none; /* Ukryte przed zalogowaniem */
            height: 100vh;
            width: 100vw;
            display: flex;
        }

        /* Sidebar (Lista pacjent√≥w) */
        .sidebar {
            width: 300px;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border);
            display: flex; flex-direction: column;
            flex-shrink: 0;
            z-index: 10;
            transition: transform 0.3s ease;
        }

        /* Main Content (Edytor) */
        .main-area {
            flex-grow: 1;
            display: flex; flex-direction: column;
            background: var(--bg);
            position: relative;
            overflow: hidden;
        }

        /* --- LOGOWANIE --- */
        #loginScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg); z-index: 5000;
            display: flex; align-items: center; justify-content: center;
            padding: 20px; box-sizing: border-box;
        }
        .login-card {
            background: var(--card-bg); width: 100%; max-width: 380px;
            padding: 40px; border-radius: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            text-align: center;
        }
        .login-logo { width: 50px; height: 50px; fill: var(--p); margin-bottom: 20px; }
        
        /* --- UI ELEMENTS --- */
        .header-bar {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
            background: var(--sidebar-bg);
        }
        .app-title { font-weight: 800; font-size: 18px; color: var(--p); display: flex; align-items: center; gap: 10px; }

        .btn-icon {
            background: transparent; border: none; color: var(--txt-muted);
            padding: 8px; border-radius: 8px; display: flex; align-items: center; justify-content: center;
        }
        .btn-icon:hover { background: var(--input-bg); color: var(--p); }
        .btn-icon svg { width: 20px; height: 20px; fill: currentColor; }

        .btn-primary {
            background: var(--p); color: white; border: none; padding: 10px 16px; border-radius: 8px;
            font-weight: 600; display: flex; align-items: center; gap: 8px; font-size: 14px;
        }
        .btn-primary:hover { background: var(--p-hover); }

        .btn-danger { background: transparent; color: var(--danger); border: 1px solid var(--danger); padding: 6px 12px; border-radius: 6px; font-size: 12px; }
        .btn-danger:hover { background: var(--danger); color: white; }

        input, select {
            width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border);
            background: var(--input-bg); color: var(--txt); box-sizing: border-box; margin-bottom: 10px;
            font-size: 14px; outline: none;
        }
        input:focus { border-color: var(--p); }

        /* Lista Pacjent√≥w */
        .scroll-area { overflow-y: auto; flex-grow: 1; padding: 10px; }
        .patient-item {
            padding: 12px 15px; border-radius: 8px; margin-bottom: 4px;
            cursor: pointer; font-weight: 500; font-size: 14px;
            display: flex; justify-content: space-between; align-items: center;
            color: var(--txt); transition: 0.2s;
        }
        .patient-item:hover { background: var(--input-bg); }
        .patient-item.active { background: var(--p); color: white; }
        .patient-item.active .patient-date { color: rgba(255,255,255,0.8); }
        
        .patient-date { font-size: 11px; color: var(--txt-muted); }

        /* Edytor */
        .editor-wrapper { display: flex; flex-direction: column; height: 100%; }
        .editor-toolbar {
            padding: 10px 20px; background: var(--bg); border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }
        #content {
            flex-grow: 1; border: none; resize: none; padding: 30px;
            font-size: 16px; line-height: 1.7; color: var(--txt);
            background: var(--bg); outline: none; font-family: 'Georgia', serif;
        }

        /* Galeria */
        .gallery-bar {
            padding: 15px 20px; background: var(--card-bg); border-top: 1px solid var(--border);
            overflow-x: auto; white-space: nowrap; height: 100px; flex-shrink: 0; display: flex; gap: 10px; align-items: center;
        }
        .thumb-wrap { position: relative; width: 80px; height: 80px; flex-shrink: 0; display: inline-block;}
        .thumb { width: 100%; height: 100%; object-fit: cover; border-radius: 6px; border: 1px solid var(--border); cursor: pointer;}
        .thumb-del { 
            position: absolute; top: -5px; right: -5px; width: 20px; height: 20px; 
            background: var(--danger); color: white; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; font-size: 12px; cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        /* --- KALENDARZ --- */
        .calendar-view { padding: 20px; overflow-y: auto; height: 100%; display: none; }
        .calendar-view.active { display: block; }
        .time-slot { display: flex; margin-bottom: 10px; align-items: center; }
        .time-label { width: 60px; font-weight: bold; color: var(--txt-muted); }

        /* --- ZEN MODE (Skupienie) --- */
        body.zen-active .sidebar { display: none; }
        body.zen-active .editor-toolbar { display: none; }
        body.zen-active .gallery-bar { display: none; }
        body.zen-active #content { 
            max-width: 800px; margin: 0 auto; 
            font-size: 18px; padding-top: 60px; 
        }
        #zenExitBtn {
            position: fixed; top: 20px; right: 20px;
            background: var(--input-bg); border: 1px solid var(--border);
            padding: 10px 20px; border-radius: 30px;
            box-shadow: var(--shadow); opacity: 0.5; transition: 0.3s;
            display: none; z-index: 1000; color: var(--txt);
        }
        body.zen-active #zenExitBtn { display: block; }
        #zenExitBtn:hover { opacity: 1; }

        /* --- RESPONSYWNO≈öƒÜ (Mobile) --- */
        .mobile-back-btn { display: none; }

        @media (max-width: 768px) {
            .sidebar { 
                position: absolute; width: 100%; height: 100%; 
                transform: translateX(0); 
            }
            .main-area { 
                position: absolute; width: 100%; height: 100%; 
                transform: translateX(100%); transition: transform 0.3s ease;
                z-index: 20;
            }
            
            /* Stan: Edycja na mobilu */
            body.mobile-editing .sidebar { transform: translateX(-20%); }
            body.mobile-editing .main-area { transform: translateX(0); }
            
            .mobile-back-btn { display: flex; margin-right: 10px; }
            #content { padding: 15px; font-size: 15px; }
            .thumb-wrap { width: 60px; height: 60px; }
        }

        /* --- MODAL IMAGE --- */
        #imgModal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 6000;
            display: none; align-items: center; justify-content: center;
        }
        #imgModal img { max-width: 95%; max-height: 95%; border-radius: 4px; }
        
        .status-msg {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: #333; color: #fff; padding: 10px 20px; border-radius: 30px;
            font-size: 13px; z-index: 7000; display: none;
        }
    </style>
</head>
<body data-theme="light">

<div id="loginScreen">
    <div class="login-card">
        <svg class="login-logo" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 14h-2v-2h2v2zm0-4h-2V7h2v5z"/></svg>
        <h2 style="margin: 0 0 10px 0; color: var(--txt-head);">Terapeutnik Pro</h2>
        <p style="color: var(--txt-muted); font-size: 14px; margin-bottom: 25px;">Szyfrowana dokumentacja medyczna</p>
        
        <div style="text-align: left;">
            <label style="font-size:12px; font-weight:bold; color:var(--txt-muted);">U≈ªYTKOWNIK</label>
            <input type="text" id="loginUser" placeholder="Login" autocomplete="username">
            
            <label style="font-size:12px; font-weight:bold; color:var(--txt-muted);">HAS≈ÅO KLUCZ</label>
            <input type="password" id="loginPass" placeholder="Has≈Ço szyfrujƒÖce" autocomplete="current-password">
        </div>

        <div style="display: flex; gap: 10px; margin-top: 20px; flex-direction: column;">
            <button class="btn-primary" style="justify-content: center; width:100%;" onclick="handleLogin('open')">üìÇ Otw√≥rz Bazƒô</button>
            <button class="btn-icon" style="width:100%; border:1px solid var(--border); color:var(--txt);" onclick="handleLogin('create')">‚ú® Utw√≥rz NowƒÖ Bazƒô</button>
        </div>
        <div id="loginMsg" style="margin-top:15px; font-size:12px; color:var(--danger);"></div>
    </div>
</div>

<div id="appLayout">
    
    <div class="sidebar">
        <div class="header-bar">
            <div class="app-title">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="var(--p)"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-2 10h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"/></svg>
                Pacjenci
            </div>
            <button class="btn-icon" onclick="toggleTheme()" title="Zmie≈Ñ motyw">
                <svg viewBox="0 0 24 24"><path d="M20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69zM12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6 6 2.69 6 6-2.69 6 6 6zm0-10c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4z"/></svg>
            </button>
        </div>
        
        <div style="padding: 10px;">
            <button class="btn-primary" style="width:100%" onclick="addPatient()">+ Nowy Pacjent</button>
        </div>

        <div class="scroll-area" id="patientList">
            </div>

        <div style="padding: 15px; border-top: 1px solid var(--border); background: var(--bg);">
            <div style="font-size: 12px; color: var(--txt-muted); margin-bottom: 5px;">Zalogowano: <b id="userDisplay"></b></div>
            <div style="display:flex; gap:10px;">
                <button class="btn-icon" style="flex:1; font-size:12px; border:1px solid var(--border);" onclick="saveToDisk()">üíæ Zapisz</button>
                <button class="btn-icon" style="flex:1; font-size:12px; border:1px solid var(--border);" onclick="switchTab('calendar')">üìÖ Kalendarz</button>
            </div>
        </div>
    </div>

    <div class="main-area">
        
        <div id="viewEditor" class="editor-wrapper">
            <div class="editor-toolbar">
                <div style="display:flex; align-items: center;">
                    <button class="btn-icon mobile-back-btn" onclick="exitMobileEdit()">
                        <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
                    </button>
                    <div style="font-weight:bold; font-size:16px;" id="currentPatientName">Wybierz pacjenta</div>
                </div>
                
                <div style="display:flex; gap: 5px;">
                    <button class="btn-icon" onclick="toggleZen()" title="Tryb Skupienia" id="btnZen">
                        <svg viewBox="0 0 24 24"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg>
                    </button>
                    <button class="btn-icon" onclick="addVisit()" title="Dodaj wizytƒô">
                        <svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>
                    </button>
                    <button class="btn-danger" onclick="deleteCurrentPatient()" title="Usu≈Ñ pacjenta">Usu≈Ñ</button>
                </div>
            </div>

            <textarea id="content" placeholder="Wybierz pacjenta i zacznij pisaƒá..." disabled oninput="saveCurrentNote()"></textarea>

            <div class="gallery-bar" id="galleryContainer" style="display:none;">
                <div class="thumb-wrap" style="display:flex; align-items:center; justify-content:center; background:var(--input-bg); border-radius:6px; cursor:pointer; border:1px dashed var(--border);" onclick="document.getElementById('imgUploader').click()">
                    <span style="font-size:24px; color:var(--txt-muted);">+</span>
                </div>
                <input type="file" id="imgUploader" accept="image/*" style="display:none;" onchange="handleImageUpload(event)">
                <div id="galleryList" style="display:contents;"></div>
            </div>
        </div>

        <div id="viewCalendar" class="calendar-view">
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:20px;">
                <button class="btn-icon mobile-back-btn" onclick="switchTab('editor')">
                    <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
                </button>
                <h2>Kalendarz</h2>
            </div>
            <input type="date" id="calDate" onchange="renderCalendar()" style="max-width:300px;">
            <div id="timeSlots" style="margin-top:20px;"></div>
        </div>

        <button id="zenExitBtn" onclick="toggleZen()">Zako≈Ñcz tryb skupienia</button>
    </div>
</div>

<div id="imgModal" onclick="this.style.display='none'">
    <img id="imgModalSrc" src="">
</div>

<div id="toast" class="status-msg"></div>

<script>
    // --- KONFIGURACJA I ZMIENNE ---
    const ITER = 100000;
    let db = { patients: {}, calendar: {} };
    let activePatientId = null;
    let fileHandle = null;
    let currentUser = "";
    let currentPass = "";

    // --- INITIALIZATION ---
    window.onload = () => {
        // Przywr√≥ƒá motyw
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.body.setAttribute('data-theme', savedTheme);
        document.getElementById('calDate').valueAsDate = new Date();
    };

    // --- UI LOGIC ---
    function toggleTheme() {
        const body = document.body;
        const current = body.getAttribute('data-theme');
        const next = current === 'dark' ? 'light' : 'dark';
        body.setAttribute('data-theme', next);
        localStorage.setItem('theme', next);
    }

    function toggleZen() {
        document.body.classList.toggle('zen-active');
        if(document.body.classList.contains('zen-active')) {
            document.getElementById('content').focus();
        }
    }

    function switchTab(tab) {
        const editor = document.getElementById('viewEditor');
        const calendar = document.getElementById('viewCalendar');
        
        if (tab === 'calendar') {
            editor.style.display = 'none';
            calendar.classList.add('active');
            renderCalendar();
            // Mobile switch
            document.body.classList.add('mobile-editing');
        } else {
            calendar.classList.remove('active');
            editor.style.display = 'flex';
            // Mobile behavior: if patient selected, stay in edit, else list
            if(!activePatientId) document.body.classList.remove('mobile-editing');
        }
    }

    function exitMobileEdit() {
        document.body.classList.remove('mobile-editing');
        // Je≈õli by≈Ç kalendarz, wr√≥ƒá do edytora
        document.getElementById('viewCalendar').classList.remove('active');
        document.getElementById('viewEditor').style.display = 'flex';
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.style.display = 'block';
        setTimeout(() => t.style.display = 'none', 3000);
    }

    // --- LOGOWANIE I PLIKI ---
    async function handleLogin(mode) {
        const user = document.getElementById('loginUser').value.trim();
        const pass = document.getElementById('loginPass').value;
        const msg = document.getElementById('loginMsg');
        
        if (!user || !pass) {
            msg.innerText = "Podaj login i has≈Ço.";
            return;
        }
        
        currentUser = user;
        currentPass = pass;

        try {
            if (mode === 'create') {
                db = { patients: {}, calendar: {} };
                if (window.showSaveFilePicker) {
                    fileHandle = await window.showSaveFilePicker({
                        suggestedName: `${user}_baza.json`,
                        types: [{ description: 'Baza JSON', accept: {'application/json': ['.json']} }]
                    });
                    await saveToDisk();
                    startApp();
                } else {
                    saveToDisk(); // Fallback download
                    startApp();
                }
            } else {
                let textData;
                if (window.showOpenFilePicker) {
                    [fileHandle] = await window.showOpenFilePicker({
                        types: [{ description: 'Baza JSON', accept: {'application/json': ['.json']} }]
                    });
                    const file = await fileHandle.getFile();
                    textData = await file.text();
                } else {
                    // Fallback input
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = '.json';
                    input.onchange = async e => {
                        const f = e.target.files[0];
                        if(f) {
                            textData = await f.text();
                            await processDecryption(textData, msg);
                        }
                    };
                    input.click();
                    return;
                }
                if(textData) await processDecryption(textData, msg);
            }
        } catch (e) {
            if(e.name !== 'AbortError') msg.innerText = "B≈ÇƒÖd: " + e.message;
        }
    }

    async function processDecryption(text, msgElem) {
        try {
            const encObj = JSON.parse(text);
            const decrypted = await decryptData(encObj, currentPass);
            db = JSON.parse(decrypted);
            if(!db.patients) db.patients = {};
            if(!db.calendar) db.calendar = {};
            startApp();
        } catch(e) {
            msgElem.innerText = "B≈Çƒôdne has≈Ço lub uszkodzony plik.";
            console.error(e);
        }
    }

    function startApp() {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('appLayout').style.display = 'flex';
        document.getElementById('userDisplay').innerText = currentUser;
        renderPatientList();
    }

    // --- KRYPTOGRAFIA (AES-GCM) ---
    function buffToBase64(buff) {
        return btoa(String.fromCharCode.apply(null, new Uint8Array(buff)));
    }
    function base64ToBuff(b64) {
        return Uint8Array.from(atob(b64), c => c.charCodeAt(0));
    }

    async function getKey(pw, salt) {
        const enc = new TextEncoder();
        const bKey = await crypto.subtle.importKey('raw', enc.encode(pw), 'PBKDF2', false, ['deriveKey']);
        return crypto.subtle.deriveKey(
            { name: 'PBKDF2', salt: salt, iterations: ITER, hash: 'SHA-256' },
            bKey, { name: 'AES-GCM', length: 256 }, false, ['encrypt', 'decrypt']
        );
    }

    async function encryptData(dataStr, pw) {
        const salt = crypto.getRandomValues(new Uint8Array(16));
        const iv = crypto.getRandomValues(new Uint8Array(12));
        const key = await getKey(pw, salt);
        const encoded = new TextEncoder().encode(dataStr);
        const ciphertext = await crypto.subtle.encrypt({name: 'AES-GCM', iv: iv}, key, encoded);
        return {
            salt: buffToBase64(salt),
            iv: buffToBase64(iv),
            data: buffToBase64(ciphertext),
            username: currentUser
        };
    }

    async function decryptData(wrapper, pw) {
        const salt = base64ToBuff(wrapper.salt);
        const iv = base64ToBuff(wrapper.iv);
        const data = base64ToBuff(wrapper.data);
        const key = await getKey(pw, salt);
        const decrypted = await crypto.subtle.decrypt({name: 'AES-GCM', iv: iv}, key, data);
        return new TextDecoder().decode(decrypted);
    }

    async function saveToDisk() {
        try {
            const jsonStr = JSON.stringify(db);
            const encrypted = await encryptData(jsonStr, currentPass);
            const finalStr = JSON.stringify(encrypted, null, 2);

            if (fileHandle) {
                const w = await fileHandle.createWritable();
                await w.write(finalStr);
                await w.close();
                showToast("Zapisano (File System API)");
            } else {
                const b = new Blob([finalStr], {type: "application/json"});
                const a = document.createElement('a');
                a.href = URL.createObjectURL(b);
                a.download = `${currentUser}_backup.json`;
                a.click();
                showToast("Pobrano plik");
            }
        } catch (e) {
            showToast("B≈ÇƒÖd zapisu: " + e.message);
        }
    }

    // --- PACJENCI ---
    function addPatient() {
        const name = prompt("Podaj imiƒô/inicja≈Çy pacjenta:");
        if (name) {
            const id = 'p_' + Date.now();
            db.patients[id] = { name: name, notes: "", images: [] };
            selectPatient(id);
            renderPatientList();
            saveToDisk();
        }
    }

    function deleteCurrentPatient() {
        if (!activePatientId) return;
        if (confirm(`UsunƒÖƒá trwale pacjenta ${db.patients[activePatientId].name}?`)) {
            // Czy≈õƒá kalendarz
            for(let d in db.calendar) {
                for(let h in db.calendar[d]) {
                    if(db.calendar[d][h] === activePatientId) delete db.calendar[d][h];
                }
            }
            delete db.patients[activePatientId];
            activePatientId = null;
            
            document.getElementById('content').value = "";
            document.getElementById('content').disabled = true;
            document.getElementById('currentPatientName').innerText = "Wybierz pacjenta";
            document.getElementById('galleryContainer').style.display = "none";
            
            renderPatientList();
            exitMobileEdit();
            saveToDisk();
        }
    }

    function renderPatientList() {
        const list = document.getElementById('patientList');
        list.innerHTML = "";
        
        Object.keys(db.patients).sort((a,b) => db.patients[a].name.localeCompare(db.patients[b].name))
        .forEach(id => {
            const p = db.patients[id];
            const div = document.createElement('div');
            div.className = `patient-item ${id === activePatientId ? 'active' : ''}`;
            div.innerHTML = `<span>${p.name}</span> <span class="patient-date">ID: ${id.slice(-4)}</span>`;
            div.onclick = () => selectPatient(id);
            list.appendChild(div);
        });
    }

    function selectPatient(id) {
        activePatientId = id;
        const p = db.patients[id];
        
        document.getElementById('currentPatientName').innerText = p.name;
        document.getElementById('content').value = p.notes;
        document.getElementById('content').disabled = false;
        document.getElementById('galleryContainer').style.display = "flex";
        
        // Mobile Transition
        document.body.classList.add('mobile-editing');
        
        renderPatientList();
        renderGallery();
    }

    function saveCurrentNote() {
        if(activePatientId) {
            db.patients[activePatientId].notes = document.getElementById('content').value;
        }
    }

    function addVisit() {
        if(!activePatientId) return;
        const now = new Date().toLocaleString('pl-PL');
        const tmpl = `\n\n--- üìÖ WIZYTA: ${now} ---\n\n> Obserwacje:\n\n> Interwencje:\n\n`;
        const ta = document.getElementById('content');
        ta.value += tmpl;
        ta.focus();
        ta.scrollTop = ta.scrollHeight;
        saveCurrentNote();
    }

    // --- ZDJƒòCIA ---
    function handleImageUpload(e) {
        if(!activePatientId || !e.target.files[0]) return;
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = (evt) => {
            // Kompresja
            const img = new Image();
            img.onload = () => {
                const c = document.createElement('canvas');
                const max = 900;
                let s = 1;
                if(img.width > max) s = max/img.width;
                c.width = img.width * s; c.height = img.height * s;
                c.getContext('2d').drawImage(img,0,0,c.width,c.height);
                
                db.patients[activePatientId].images.push(c.toDataURL('image/jpeg', 0.7));
                renderGallery();
                saveToDisk();
                document.getElementById('imgUploader').value = '';
            }
            img.src = evt.target.result;
        }
        reader.readAsDataURL(file);
    }

    function renderGallery() {
        const list = document.getElementById('galleryList');
        list.innerHTML = "";
        if(!activePatientId) return;
        
        (db.patients[activePatientId].images || []).forEach((src, idx) => {
            const w = document.createElement('div');
            w.className = 'thumb-wrap';
            
            const img = document.createElement('img');
            img.className = 'thumb';
            img.src = src;
            img.onclick = () => {
                document.getElementById('imgModalSrc').src = src;
                document.getElementById('imgModal').style.display = 'flex';
            };

            const del = document.createElement('div');
            del.className = 'thumb-del';
            del.innerText = '√ó';
            del.onclick = (e) => {
                e.stopPropagation();
                if(confirm("UsunƒÖƒá zdjƒôcie?")) {
                    db.patients[activePatientId].images.splice(idx, 1);
                    renderGallery();
                    saveToDisk();
                }
            };
            
            w.append(img, del);
            list.appendChild(w);
        });
    }

    // --- KALENDARZ ---
    function renderCalendar() {
        const date = document.getElementById('calDate').value;
        const con = document.getElementById('timeSlots');
        con.innerHTML = "";
        
        if(!db.calendar[date]) db.calendar[date] = {};
        
        for(let h=8; h<=20; h++) {
            const time = (h<10?'0'+h:h) + ":00";
            const row = document.createElement('div');
            row.className = 'time-slot';
            
            const sel = document.createElement('select');
            sel.innerHTML = `<option value="">--</option>`;
            
            Object.keys(db.patients).forEach(pid => {
                const opt = document.createElement('option');
                opt.value = pid;
                opt.innerText = db.patients[pid].name;
                if(db.calendar[date][time] === pid) opt.selected = true;
                sel.appendChild(opt);
            });
            
            sel.onchange = (e) => {
                db.calendar[date][time] = e.target.value;
                saveToDisk();
            };

            row.innerHTML = `<div class="time-label">${time}</div>`;
            row.appendChild(sel);
            con.appendChild(row);
        }
    }
</script>
</body>
</html>
