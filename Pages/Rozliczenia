import React, { useState, useEffect } from "react";
import { Wizyta } from "@/entities/Wizyta";
import { User } from "@/entities/User";
import { Button } from "@/components/ui/button";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Card } from "@/components/ui/card";
import { Loader2, Calendar as CalendarIcon } from "lucide-react";
import { format, startOfMonth, endOfMonth, getMonth, getYear } from "date-fns";
import { pl } from "date-fns/locale";
import BillingTable from "../components/billing/BillingTable";

export default function Rozliczenia() {
  const [visits, setVisits] = useState([]);
  const [isLoading, setIsLoading] = useState(true);
  const [selectedMonth, setSelectedMonth] = useState(new Date().getMonth().toString());
  const [selectedYear, setSelectedYear] = useState(new Date().getFullYear().toString());

  const months = [
    { value: "0", label: "Styczeń" },
    { value: "1", label: "Luty" },
    { value: "2", label: "Marzec" },
    { value: "3", label: "Kwiecień" },
    { value: "4", label: "Maj" },
    { value: "5", label: "Czerwiec" },
    { value: "6", label: "Lipiec" },
    { value: "7", label: "Sierpień" },
    { value: "8", label: "Wrzesień" },
    { value: "9", label: "Październik" },
    { value: "10", label: "Listopad" },
    { value: "11", label: "Grudzień" }
  ];

  const years = Array.from({ length: 5 }, (_, i) => (new Date().getFullYear() - 2 + i).toString());

  useEffect(() => {
    loadVisits();
  }, [selectedMonth, selectedYear]);

  const loadVisits = async () => {
    setIsLoading(true);
    try {
      const user = await User.me();
      // Fetch all visits for the user and then filter by date
      // In a real app with more data, we would filter in the query if supported
      const allVisits = await Wizyta.filter({ created_by: user.email });
      
      const start = startOfMonth(new Date(parseInt(selectedYear), parseInt(selectedMonth)));
      const end = endOfMonth(new Date(parseInt(selectedYear), parseInt(selectedMonth)));

      const filteredVisits = allVisits.filter(visit => {
        const visitDate = new Date(visit.start_time);
        return visitDate >= start && visitDate <= end && visit.status !== 'odwołana';
      });

      // Sort by date desc
      filteredVisits.sort((a, b) => new Date(b.start_time) - new Date(a.start_time));
      
      setVisits(filteredVisits);
    } catch (error) {
      console.error("Błąd podczas ładowania wizyt:", error);
    }
    setIsLoading(false);
  };

  const handleTogglePayment = async (visit) => {
    const newStatus = visit.payment_status === 'oplacona' ? 'nieoplacona' : 'oplacona';
    try {
      await Wizyta.update(visit.id, { payment_status: newStatus });
      
      // Optimistic update
      setVisits(prev => prev.map(v => 
        v.id === visit.id ? { ...v, payment_status: newStatus } : v
      ));
    } catch (error) {
      console.error("Błąd podczas aktualizacji statusu płatności:", error);
    }
  };

  const groupVisitsByPatient = () => {
    const groups = {};
    
    visits.forEach(visit => {
      if (!groups[visit.patient_id]) {
        groups[visit.patient_id] = {
          patientId: visit.patient_id,
          patientName: visit.patient_name || "Nieznany pacjent",
          visits: [],
          total: 0,
          paid: 0,
          unpaid: 0
        };
      }
      
      groups[visit.patient_id].visits.push(visit);
      groups[visit.patient_id].total += 1;
      if (visit.payment_status === 'oplacona') {
        groups[visit.patient_id].paid += 1;
      } else {
        groups[visit.patient_id].unpaid += 1;
      }
    });

    return groups;
  };

  return (
    <div className="p-6 bg-gradient-to-br from-slate-50 to-blue-50 min-h-screen">
      <div className="max-w-7xl mx-auto space-y-6">
        <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
          <div className="flex items-center gap-3">
            <div className="w-10 h-10 bg-green-100 rounded-xl flex items-center justify-center">
              <CalendarIcon className="w-6 h-6 text-green-600" />
            </div>
            <div>
              <h1 className="text-3xl font-bold text-gray-900">Rozliczenia</h1>
              <p className="text-gray-600 mt-1">
                Monitoruj wizyty i status płatności
              </p>
            </div>
          </div>

          <div className="flex gap-3 bg-white p-2 rounded-lg shadow-sm border">
            <Select value={selectedMonth} onValueChange={setSelectedMonth}>
              <SelectTrigger className="w-[140px]">
                <SelectValue placeholder="Miesiąc" />
              </SelectTrigger>
              <SelectContent>
                {months.map(month => (
                  <SelectItem key={month.value} value={month.value}>{month.label}</SelectItem>
                ))}
              </SelectContent>
            </Select>

            <Select value={selectedYear} onValueChange={setSelectedYear}>
              <SelectTrigger className="w-[100px]">
                <SelectValue placeholder="Rok" />
              </SelectTrigger>
              <SelectContent>
                {years.map(year => (
                  <SelectItem key={year} value={year}>{year}</SelectItem>
                ))}
              </SelectContent>
            </Select>
          </div>
        </div>

        {isLoading ? (
          <div className="flex items-center justify-center h-64">
            <Loader2 className="w-8 h-8 animate-spin text-blue-600" />
          </div>
        ) : (
          <div className="grid gap-6">
             <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <Card className="bg-white/80 backdrop-blur-sm">
                  <div className="p-6">
                    <p className="text-sm text-gray-500 font-medium uppercase tracking-wider">Wszystkie wizyty</p>
                    <p className="text-3xl font-bold text-gray-900 mt-2">{visits.length}</p>
                  </div>
                </Card>
                <Card className="bg-white/80 backdrop-blur-sm border-l-4 border-l-green-500">
                  <div className="p-6">
                    <p className="text-sm text-green-600 font-medium uppercase tracking-wider">Opłacone</p>
                    <p className="text-3xl font-bold text-green-700 mt-2">
                      {visits.filter(v => v.payment_status === 'oplacona').length}
                    </p>
                  </div>
                </Card>
                <Card className="bg-white/80 backdrop-blur-sm border-l-4 border-l-orange-500">
                  <div className="p-6">
                    <p className="text-sm text-orange-600 font-medium uppercase tracking-wider">Do opłacenia</p>
                    <p className="text-3xl font-bold text-orange-700 mt-2">
                      {visits.filter(v => v.payment_status !== 'oplacona').length}
                    </p>
                  </div>
                </Card>
             </div>

             <BillingTable 
               groupedVisits={groupVisitsByPatient()} 
               onTogglePayment={handleTogglePayment}
             />
          </div>
        )}
      </div>
    </div>
  );
}
