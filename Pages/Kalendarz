import { useState, useEffect, useCallback } from "react";
import { Wizyta } from "@/entities/Wizyta";
import { Patient } from "@/entities/Patient";
import { User } from "@/entities/User";
import { Loader2 } from "lucide-react";
import {
  startOfDay,
  endOfDay,
  add,
  startOfWeek,
  endOfWeek,
  startOfMonth,
  endOfMonth,
  isWithinInterval
} from "date-fns";
import { pl } from "date-fns/locale";

import CalendarHeader from "../components/calendar/CalendarHeader";
import DayView from "../components/calendar/DayView";
import WeekView from "../components/calendar/WeekView";
import MonthView from "../components/calendar/MonthView";
import AppointmentModal from "../components/calendar/AppointmentModal";

export default function Kalendarz() {
  const [selectedDate, setSelectedDate] = useState(new Date());
  const [view, setView] = useState("day");
  const [appointments, setAppointments] = useState([]);
  const [allAppointments, setAllAppointments] = useState([]);
  const [patients, setPatients] = useState([]);
  const [isLoading, setIsLoading] = useState(true);
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [modalData, setModalData] = useState(null);
  const [user, setUser] = useState(null);

  useEffect(() => {
    const init = async () => {
      try {
        const currentUser = await User.me();
        setUser(currentUser);
      } catch (error) {
        console.error("Błąd podczas ładowania użytkownika:", error);
      }
    };
    init();
  }, []);

  const fetchData = useCallback(async () => {
    if (!user) return;
    setIsLoading(true);
    try {
      const [appointmentsData, patientsData] = await Promise.all([
        Wizyta.filter({
          created_by: user.email
        }, '-start_time'),
        Patient.filter({ created_by: user.email })
      ]);
      setAllAppointments(appointmentsData);
      setPatients(patientsData);
    } catch (error) {
      console.error("Błąd podczas ładowania danych:", error);
    }
    setIsLoading(false);
  }, [user]);

  useEffect(() => {
    fetchData();
  }, [fetchData]);

  useEffect(() => {
    let interval;
    if (view === 'day') {
      interval = { start: startOfDay(selectedDate), end: endOfDay(selectedDate) };
    } else if (view === 'week') {
      interval = { start: startOfWeek(selectedDate, { locale: pl }), end: endOfWeek(selectedDate, { locale: pl }) };
    } else { // month
      interval = { start: startOfMonth(selectedDate), end: endOfMonth(selectedDate) };
    }

    const filteredAppointments = allAppointments.filter(app => {
      try {
        const appDate = new Date(app.start_time);
        return isWithinInterval(appDate, interval);
      } catch (e) {
        return false;
      }
    });
    setAppointments(filteredAppointments);
  }, [selectedDate, view, allAppointments]);


  const handleAddAppointment = (startTime) => {
    const appointmentStart = new Date(startTime);
    const appointmentEnd = add(appointmentStart, { hours: 1 });
    
    setModalData({
      appointment: { 
        start_time: appointmentStart,
        end_time: appointmentEnd 
      },
      isEditing: false
    });
    setIsModalOpen(true);
  };

  const handleEditAppointment = (appointment) => {
    setModalData({ 
      appointment: {
        ...appointment,
        start_time: new Date(appointment.start_time),
        end_time: new Date(appointment.end_time)
      }, 
      isEditing: true 
    });
    setIsModalOpen(true);
  };

  const handleSaveAppointment = async (data, isEditing) => {
    try {
      const appointmentData = {
        ...data,
        start_time: new Date(data.start_time).toISOString(),
        end_time: new Date(data.end_time).toISOString()
      };

      if (isEditing) {
        await Wizyta.update(data.id, appointmentData);
      } else {
        await Wizyta.create(appointmentData);
      }
      
      await fetchData(); // Refetch all appointments
      setIsModalOpen(false);
      setModalData(null);
    } catch (error) {
      console.error("Błąd podczas zapisywania wizyty:", error);
      alert("Wystąpił błąd podczas zapisywania wizyty. Spróbuj ponownie.");
    }
  };

  const handleDeleteAppointment = async (id) => {
    try {
      await Wizyta.delete(id);
      await fetchData(); // Refetch all appointments
      setIsModalOpen(false);
      setModalData(null);
    } catch (error) {
      console.error("Błąd podczas usuwania wizyty:", error);
      alert("Wystąpił błąd podczas usuwania wizyty. Spróbuj ponownie.");
    }
  };

  const handleCloseModal = () => {
    setIsModalOpen(false);
    setModalData(null);
  };

  const renderView = () => {
    switch (view) {
      case 'week':
        return <WeekView
          selectedDate={selectedDate}
          appointments={appointments}
          onAddAppointment={handleAddAppointment}
          onEditAppointment={handleEditAppointment}
        />;
      case 'month':
        return <MonthView
          selectedDate={selectedDate}
          appointments={appointments}
          onAddAppointment={handleAddAppointment}
          onDateClick={(date) => {
            setSelectedDate(date);
            setView('day');
          }}
        />;
      case 'day':
      default:
        return <DayView
          selectedDate={selectedDate}
          appointments={appointments}
          onAddAppointment={handleAddAppointment}
          onEditAppointment={handleEditAppointment}
        />;
    }
  };

  return (
    <div className="p-6 bg-gradient-to-br from-slate-50 to-blue-50 min-h-screen">
      <div className="max-w-7xl mx-auto flex flex-col h-full">
        <CalendarHeader 
          selectedDate={selectedDate}
          setSelectedDate={setSelectedDate}
          view={view}
          setView={setView}
        />
        
        <div className="mt-6 flex-1">
          {isLoading ? (
            <div className="flex justify-center items-center h-64">
              <Loader2 className="w-8 h-8 text-blue-600 animate-spin" />
            </div>
          ) : (
            renderView()
          )}
        </div>
      </div>
      
      {isModalOpen && modalData && (
        <AppointmentModal
          isOpen={isModalOpen}
          onClose={handleCloseModal}
          appointmentData={modalData.appointment}
          isEditing={modalData.isEditing}
          patients={patients}
          onSave={handleSaveAppointment}
          onDelete={handleDeleteAppointment}
        />
      )}
    </div>
  );
}
